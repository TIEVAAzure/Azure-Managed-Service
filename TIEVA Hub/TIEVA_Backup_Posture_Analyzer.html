<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TIEVA ‚Äî Backup Posture Analyzer</title>
<style>
:root{--tieva-teal:#2DA58E;--tieva-navy:#1B365D;--critical:#ef4444;--warning:#f59e0b;--success:#10b981;--fg:#111827;--muted:#6b7280;--border:#e5e7eb;--canvas:var(--tieva-teal);--content-max:1440px}
*{box-sizing:border-box;margin:0;padding:0}body{background:var(--canvas);color:var(--fg);font:14px/1.5 'Segoe UI',system-ui,sans-serif}
.wrap{max-width:var(--content-max);margin:0 auto;padding:24px}
.brandbar{background:var(--tieva-navy);color:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.15)}
.brandwrap{max-width:var(--content-max);margin:0 auto;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
.brandtitle{font-size:20px;font-weight:700}.brandsubtitle{font-size:12px;opacity:0.85;margin-top:2px}
.btnrow{display:flex;gap:8px;flex-wrap:wrap}
.header-btn{border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.1);color:#fff;border-radius:6px;padding:8px 14px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s}
.header-btn:hover{background:rgba(255,255,255,.25)}.header-btn:disabled{opacity:0.5;cursor:not-allowed}
.pagetitle{font-size:26px;font-weight:700;color:#fff;margin-bottom:8px}.pagedesc{font-size:14px;color:rgba(255,255,255,0.9);margin-bottom:20px}
.row{display:flex;gap:20px;flex-wrap:wrap}.col{flex:1 1 360px}
.card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
h2{margin:0 0 14px;font-size:18px;color:var(--tieva-navy)}h3{margin:0 0 12px;font-size:16px;color:var(--tieva-navy)}.muted{color:var(--muted)}
.btn{padding:10px 16px;border:1px solid var(--border);border-radius:8px;background:#f9fafb;cursor:pointer;font-size:13px;font-weight:500}
.btn.primary{background:var(--tieva-teal);color:#fff;border-color:var(--tieva-teal)}
input[type=file]{border:2px dashed var(--border);border-radius:8px;padding:12px;background:#f9fafb;cursor:pointer;width:100%}
input[type=file]:hover{border-color:var(--tieva-teal);background:#f0fdf4}
input[type=text]{border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-size:14px;width:100%}
input[type=text]:focus{outline:none;border-color:var(--tieva-teal)}
label{font-weight:600;font-size:13px;display:block;margin-bottom:6px}.hint{font-size:12px;color:var(--muted);margin-top:4px}
.score-container{display:flex;align-items:center;gap:24px;padding:24px;background:linear-gradient(135deg,#f8fafc,#f1f5f9);border-radius:12px;margin-bottom:20px}
.score-ring{position:relative;width:140px;height:140px;flex-shrink:0}
.score-ring svg{transform:rotate(-90deg);width:140px;height:140px}
.score-ring circle{fill:none;stroke-width:12}.score-ring .bg{stroke:#e5e7eb}.score-ring .progress{stroke-linecap:round;transition:stroke-dashoffset 0.8s ease}
.score-value{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.score-value .number{font-size:36px;font-weight:700;color:var(--tieva-navy)}.score-value .label{font-size:11px;color:var(--muted);text-transform:uppercase}
.score-details{flex:1}.score-details h3{margin:0 0 8px;font-size:20px}.score-details p{margin:0 0 12px;color:var(--muted);font-size:14px}
.score-badge{display:inline-block;padding:6px 14px;border-radius:999px;font-size:13px;font-weight:600}
.score-badge.critical{background:#fee2e2;color:#dc2626}.score-badge.warning{background:#fef3c7;color:#d97706}
.score-badge.good{background:#d1fae5;color:#059669}.score-badge.excellent{background:#dbeafe;color:#1d4ed8}
.report-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;padding:20px;background:#fff;border-radius:12px;border-left:4px solid var(--tieva-teal)}
.report-header .customer-name{font-size:24px;font-weight:700;color:var(--tieva-navy)}.report-header .report-type{font-size:14px;color:var(--muted);margin-top:4px}
.report-header .report-meta{text-align:right;font-size:13px;color:var(--muted)}.report-header .report-meta div{margin-bottom:6px}.report-header .report-meta strong{color:var(--fg)}
.tiles{display:flex;gap:14px;flex-wrap:wrap}.tile{flex:1 1 150px;border:1px solid var(--border);border-radius:10px;padding:16px;background:#fff}
.tile h4{margin:0 0 8px;font-size:11px;color:var(--muted);text-transform:uppercase;font-weight:600}.tile .big{font-size:28px;font-weight:700;color:var(--tieva-navy)}
table{border-collapse:collapse;width:100%}thead{background:var(--tieva-teal);color:#fff}
th{text-align:left;padding:10px 12px;font-weight:600;font-size:12px;text-transform:uppercase}
td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:top}
tbody tr:hover{background:#f9fafb}tbody tr[data-filter]{cursor:pointer}tbody tr[data-filter]:hover{background:#f0fdf4}
.scroller{max-height:480px;overflow:auto}
.tag{display:inline-block;padding:3px 10px;border-radius:999px;font-size:11px;font-weight:600;color:#fff}
.tag.high{background:var(--critical)}.tag.medium{background:var(--warning)}.tag.low{background:var(--success)}
.pill{display:inline-block;font-size:12px;border-radius:999px;padding:4px 10px;border:1px solid var(--border);background:#f9fafb}
.filterbar{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.section{display:none}.section.visible{display:block}
.loading-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.95);z-index:9999;justify-content:center;align-items:center;flex-direction:column;gap:20px}
.loading-overlay.active{display:flex}
.spinner{width:56px;height:56px;border:5px solid var(--border);border-top-color:var(--tieva-teal);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:18px;color:var(--tieva-navy);font-weight:600}
.toast-container{position:fixed;top:24px;right:24px;z-index:10000;display:flex;flex-direction:column;gap:12px}
.toast{background:#fff;border-radius:10px;padding:16px 20px;box-shadow:0 8px 24px rgba(0,0,0,0.15);animation:slideIn 0.3s ease;max-width:420px}
.toast.success{border-left:4px solid var(--success)}.toast.error{border-left:4px solid var(--critical)}.toast.info{border-left:4px solid var(--tieva-teal)}
@keyframes slideIn{from{transform:translateX(120%)}to{transform:translateX(0)}}
.roadmap-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:16px}
.wave-card{border:2px solid var(--border);border-radius:12px;padding:16px;background:#fff}.wave-card.priority-1{border-left:4px solid var(--success)}
.wave-card.priority-2{border-left:4px solid var(--tieva-teal)}.wave-card.priority-3{border-left:4px solid var(--warning)}
.wave-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.wave-title{font-weight:700;font-size:15px;color:var(--tieva-navy)}
.wave-badge{font-size:11px;padding:4px 10px;border-radius:999px;font-weight:600}
.wave-badge.quick{background:#d1fae5;color:#059669}.wave-badge.standard{background:#dbeafe;color:#1d4ed8}.wave-badge.complex{background:#fef3c7;color:#d97706}
.wave-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px}
.wave-stat{padding:8px;background:#f9fafb;border-radius:6px}.wave-stat-label{color:var(--muted);font-size:11px}.wave-stat-value{font-weight:700;color:var(--tieva-navy)}
.compliance-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
.compliance-card{border:1px solid var(--border);border-radius:12px;padding:20px;background:#fff}
.compliance-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.compliance-icon{width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
.compliance-icon.iso{background:#dbeafe;color:#1d4ed8}.compliance-icon.nist{background:#fef3c7;color:#d97706}.compliance-icon.cis{background:#d1fae5;color:#059669}.compliance-icon.azure{background:#e0e7ff;color:#4f46e5}
.compliance-title{font-weight:700;font-size:16px;color:var(--tieva-navy)}.compliance-subtitle{font-size:12px;color:var(--muted)}
.compliance-bar{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin:12px 0}
.compliance-fill{height:100%;border-radius:999px;transition:width 0.6s ease}
.compliance-stats{display:flex;justify-content:space-between;font-size:13px;color:var(--muted)}
.exec-summary{background:#fff;border-radius:12px;padding:24px;margin-bottom:20px}
.exec-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-top:20px}
.exec-metric{text-align:center;padding:20px;background:#f8fafc;border-radius:10px}
.exec-metric .value{font-size:36px;font-weight:700;color:var(--tieva-navy)}.exec-metric .label{font-size:12px;color:var(--muted);text-transform:uppercase;margin-top:4px}
.exec-highlights{margin-top:20px}
.exec-highlight{display:flex;align-items:center;gap:12px;padding:12px;border-left:3px solid var(--tieva-teal);background:#f8fafc;margin-bottom:8px;border-radius:0 8px 8px 0}
.top-actions{margin-top:20px}
.top-action{display:flex;align-items:center;gap:12px;padding:12px 16px;background:#fff;border:1px solid var(--border);border-radius:8px;margin-bottom:8px}
.top-action-num{width:28px;height:28px;background:var(--tieva-navy);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px}
.top-action-text{flex:1;font-size:14px}.top-action-sev{font-weight:600}
@media print{.brandbar,.header-btn,.btn,input,.loading-overlay,.toast-container,#uploadCard{display:none!important}.wrap{padding:0}.card{box-shadow:none;page-break-inside:avoid}.section.visible{display:block!important}body{background:#fff}}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><div class="loading-text" id="loadingText">Generating report...</div></div>
<div class="toast-container" id="toastContainer"></div>
<div class="brandbar"><div class="brandwrap">
<div><div class="brandtitle">TIEVA ‚Äî Backup Posture Analyzer</div><div class="brandsubtitle">Azure Backup & DR Assessment Tool</div></div>
<div class="btnrow">
<button id="btnExecPDF" class="header-btn" disabled>Executive Summary</button>
<button id="btnRoadmap" class="header-btn" disabled>Export Roadmap</button>
<button id="btnCSV" class="header-btn" disabled>Customer Review</button>
<button id="btnPDF" class="header-btn" disabled>Full Report PDF</button>
</div>
</div></div>
<div class="wrap" id="mainContent">
<div class="pagetitle">Backup & DR Posture Overview</div>
<div class="pagedesc">Upload your Backup_Audit.xlsx and Backup_Effort_Mapping.xlsx to analyze vault configurations, compliance gaps, and remediation priorities.</div>
<div class="card" id="uploadCard">
<div class="row"><div class="col"><label for="customerName">Customer Name</label><input type="text" id="customerName" placeholder="Enter customer name for report header"/></div></div>
<div class="row" style="margin-top:16px">
<div class="col"><label>1) Backup Audit (XLSX)</label><input id="auditFile" type="file" accept=".xlsx"/><div class="hint">Sheets: RSV, BackupVaults, VM_Coverage, Findings</div></div>
<div class="col"><label>2) Effort Mapping (XLSX)</label><input id="mapFile" type="file" accept=".xlsx"/><div class="hint">Sheet: Mapping with Finding, BaseHours, PerResourceHours</div></div>
<div class="col" style="display:flex;align-items:flex-end"><div style="display:flex;gap:10px"><button id="btnGo" class="btn primary">Generate Report</button><button id="btnClear" class="btn">Clear Filter</button></div></div>
</div>
</div>
<div id="reportHeaderSec" class="section"><div class="report-header">
<div><div class="customer-name" id="rptCustomer">Customer Report</div><div class="report-type">Backup & DR Posture Analysis</div></div>
<div class="report-meta"><div><strong>Generated:</strong> <span id="rptTime"></span></div><div><strong>Findings:</strong> <span id="rptItems">0</span></div><div><strong>Report ID:</strong> <span id="rptId"></span></div></div>
</div></div>
<div id="execSec" class="section"><div class="exec-summary">
<h2>üìä Executive Summary</h2>
<div class="exec-grid">
<div class="exec-metric"><div class="value" id="execScore">0</div><div class="label">Posture Score</div></div>
<div class="exec-metric"><div class="value" id="execHours">0</div><div class="label">Remediation Hours</div></div>
<div class="exec-metric"><div class="value" id="execItems">0</div><div class="label">Findings</div></div>
</div>
<div class="exec-highlights">
<div class="exec-highlight"><span>üéØ</span><span id="execHighlight1">-</span></div>
<div class="exec-highlight"><span>‚ö†Ô∏è</span><span id="execHighlight2">-</span></div>
<div class="exec-highlight"><span>‚úÖ</span><span id="execHighlight3">-</span></div>
</div>
<div class="top-actions"><h3 style="margin-bottom:12px">Top 5 Priority Findings</h3><div id="topActions"></div></div>
</div></div>
<div id="scoreSec" class="section"><div class="score-container">
<div class="score-ring"><svg viewBox="0 0 140 140"><circle class="bg" cx="70" cy="70" r="58"/><circle class="progress" id="scoreCircle" cx="70" cy="70" r="58" stroke-dasharray="364" stroke-dashoffset="364" stroke="#e5e7eb"/></svg>
<div class="score-value"><div class="number" id="scoreNum">0</div><div class="label">Score</div></div></div>
<div class="score-details"><h3>Backup Posture Score</h3><p id="scoreDesc">Upload data to calculate your backup posture score.</p><span class="score-badge" id="scoreBadge">Pending</span></div>
</div></div>
<div id="kpiSec" class="section"><div class="card"><h2>At a Glance</h2>
<div class="tiles">
<div class="tile"><h4>Total Hours</h4><div class="big" id="kpiHours">0</div></div>
<div class="tile"><h4>Findings</h4><div class="big" id="kpiItems">0</div></div>
<div class="tile"><h4>High Severity</h4><div class="big" id="kpiHigh">0</div></div>
<div class="tile"><h4>Medium Severity</h4><div class="big" id="kpiMed">0</div></div>
<div class="tile"><h4>Vaults</h4><div class="big" id="kpiVaults">0</div></div>
<div class="tile"><h4>VMs Unprotected</h4><div class="big" id="kpiVMs">0</div></div>
</div></div></div>
<div id="roadmapSec" class="section"><div class="card"><h2>üó∫Ô∏è Remediation Roadmap</h2><p class="muted" style="margin-bottom:16px">Prioritised waves based on severity and effort.</p><div class="roadmap-grid" id="roadmapGrid"></div></div></div>
<div id="complianceSec" class="section"><div class="card"><h2>üìã Compliance Mapping</h2><p class="muted" style="margin-bottom:16px">How backup findings map to compliance frameworks.</p><div class="compliance-grid" id="complianceGrid"></div></div></div>
<div id="summarySec" class="section"><div class="card"><h2>Summary</h2>
<div class="row">
<div class="col"><h3>By Finding</h3><div id="tblFinding" class="scroller"></div></div>
<div class="col"><h3>By Owner</h3><div id="tblOwner" class="scroller"></div></div>
<div class="col"><h3>By Severity</h3><div id="tblSeverity" class="scroller"></div></div>
</div>
<div class="row" style="margin-top:20px">
<div class="col"><h3>By Category</h3><div id="tblCategory" class="scroller"></div></div>
<div class="col"><h3>By Subscription</h3><div id="tblSub" class="scroller"></div></div>
</div></div></div>
<div id="detailSec" class="section"><div class="card">
<div class="filterbar"><h2 style="margin:0">Finding Details</h2><span class="pill" id="activeFilter" style="display:none"></span></div>
<div id="tblDetail" class="scroller"></div>
</div></div>
</div>
<script>
const el=id=>document.getElementById(id);const fmt=n=>isFinite(n)?Math.round(n*10)/10:0;const norm=s=>String(s||"").trim().replace(/\s+/g," ").toLowerCase();
let DATA={rsv:[],bv:[],vm:[],findings:[]},DETAIL=[],MAPPING={},FILTER=null;
function toast(msg,type='info',dur=4000){const c=el('toastContainer'),t=document.createElement('div');t.className='toast '+type;t.textContent=msg;c.appendChild(t);setTimeout(()=>t.remove(),dur)}
function showLoad(txt){el('loadingText').textContent=txt;el('loadingOverlay').classList.add('active')}
function hideLoad(){el('loadingOverlay').classList.remove('active')}
function genId(){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';let id='BKP-';for(let i=0;i<8;i++)id+=c[Math.floor(Math.random()*c.length)];return id}
function fmtTime(d=new Date()){return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'})}
function readSheet(wb,n){return wb.SheetNames.includes(n)?XLSX.utils.sheet_to_json(wb.Sheets[n],{defval:""}):[]}
function getCI(o,k){const t=k.toLowerCase();for(const x of Object.keys(o))if(x.toLowerCase()===t)return o[x];return undefined}
function renderTable(container,cols,rows,ck){let h='<table><thead><tr>';cols.forEach(c=>h+='<th>'+c.header+'</th>');h+='</tr></thead><tbody>';rows.forEach(r=>{const v=ck?r[ck]:null,a=(ck&&v!=null)?' data-filter="'+ck+'" data-value="'+encodeURIComponent(v)+'"':'';h+='<tr'+a+'>';cols.forEach(c=>h+='<td>'+(c.render?c.render(r):(r[c.key]||""))+'</td>');h+='</tr>'});h+='</tbody></table>';container.innerHTML=h;if(ck)container.querySelectorAll('tr[data-filter]').forEach(tr=>tr.addEventListener('click',()=>applyFilter(tr.getAttribute('data-filter'),decodeURIComponent(tr.getAttribute('data-value')))))}
function groupBy(a,k){const m={};a.forEach(x=>{const key=x[k]||"";(m[key]=m[key]||[]).push(x)});return m}
function sevClass(v){const s=(v||"").toLowerCase();return s.startsWith('h')?'high':s.startsWith('m')?'medium':s.startsWith('l')?'low':''}
function sevBadge(r){return '<span class="tag '+sevClass(r.severity)+'">'+(r.severity||"n/a")+'</span>'}
function parseMapping(wb){const sh=wb.Sheets["Mapping"];if(!sh)throw new Error('Need Mapping sheet');const rows=XLSX.utils.sheet_to_json(sh,{defval:""}),map={};rows.forEach(r=>{const f=String(getCI(r,"Finding")||"").trim();if(!f)return;map[norm(f)]={base:Number(getCI(r,"BaseHours")||0),per:Number(getCI(r,"PerResourceHours")||0),owner:getCI(r,"Owner")||"",pillar:getCI(r,"Pillar")||""}});return map}
function deriveFindings(audit){const findings=[];const rsv=readSheet(audit,'RSV'),bv=readSheet(audit,'BackupVaults'),vm=readSheet(audit,'VM_Coverage'),rawFindings=readSheet(audit,'Findings');DATA={rsv,bv,vm,findings:rawFindings};rawFindings.forEach(f=>{findings.push({subscription:f.SubscriptionName||"",category:f.Category||"",resourceType:f.ResourceType||"",resourceName:f.ResourceName||"",resourceGroup:f.ResourceGroup||"",finding:f.Detail||f.Finding||"",severity:f.Severity||"Medium"})});[...rsv,...bv].forEach(v=>{const vn=v.VaultName||"";if(String(v.AlwaysOnSoftDelete||"").toLowerCase()!=='true')findings.push({subscription:v.SubscriptionName||"",category:'Vault',resourceType:v.VaultType||"Vault",resourceName:vn,resourceGroup:v.ResourceGroup||"",finding:'Enable always-on soft delete',severity:'High'});if(String(v.MUAEnabled||"").toLowerCase()!=='true')findings.push({subscription:v.SubscriptionName||"",category:'Vault',resourceType:v.VaultType||"Vault",resourceName:vn,resourceGroup:v.ResourceGroup||"",finding:'Enable multi-user authorisation',severity:'High'})});vm.forEach(v=>{if(String(v.IsBackedUp||"").toLowerCase()!=='true')findings.push({subscription:v.SubscriptionName||"",category:'VM',resourceType:'Virtual Machine',resourceName:v.VMName||"",resourceGroup:v.ResourceGroup||"",finding:'VM not protected',severity:'High'})});return findings}
function enrichFindings(raw,map){return raw.map(f=>{const k=norm(f.finding),m=map[k]||{};return{...f,owner:m.owner||"",pillar:m.pillar||"",baseCfg:m.base||0,per:m.per||0,baseShow:0,total:0}}).map((r,i,arr)=>{const grp=arr.filter(x=>norm(x.finding)===norm(r.finding));const b=r.baseCfg,p=r.per,n=grp.length,bp=n?b/n:0;r.baseShow=bp;r.total=p+bp;return r})}
function calcScore(data){console.log('calcScore called with data length:',data.length);const hi=data.filter(d=>/^h/i.test(d.severity)).length,med=data.filter(d=>/^m/i.test(d.severity)).length,low=data.filter(d=>/^l/i.test(d.severity)).length;const total=data.length||1;console.log('hi:',hi,'med:',med,'low:',low);const hiPct=(hi/total)*100,medPct=(med/total)*100,lowPct=(low/total)*100;let s=100-(hiPct*0.6)-(medPct*0.3)-(lowPct*0.1);s=Math.max(0,Math.min(100,Math.round(s)));let l,c;if(s>=80){l='Excellent';c='excellent'}else if(s>=60){l='Good';c='good'}else if(s>=40){l='Needs Attention';c='warning'}else{l='Critical';c='critical'};console.log('calcScore returning score:',s,'label:',l);return{score:s,label:l,cls:c}}
function updateScore(sc){console.log('updateScore - score value:',sc.score,'label:',sc.label);const circ=364,off=circ-(sc.score/100)*circ;console.log('strokeDashoffset will be:',off);const circle=el('scoreCircle');const num=el('scoreNum');if(circle){circle.style.strokeDashoffset=String(off);circle.style.stroke=sc.score>=80?'#10b981':sc.score>=60?'#3b82f6':sc.score>=40?'#f59e0b':'#ef4444';console.log('Set circle stroke to:',circle.style.stroke);}if(num){num.textContent=String(sc.score);console.log('Set num to:',num.textContent);}el('scoreBadge').textContent=sc.label;el('scoreBadge').className='score-badge '+sc.cls;const desc={excellent:'Excellent backup posture.',good:'Good progress on backup coverage.',warning:'Attention needed on backup gaps.',critical:'Critical backup gaps require action.'};el('scoreDesc').textContent=desc[sc.cls]}
function applyFilter(k,v){FILTER={key:k,value:v,fn:d=>{if(k==='finding')return norm(d.finding)===norm(v);if(k==='owner')return(d.owner||"")===v;if(k==='severity')return(d.severity||"")===v;if(k==='category')return(d.category||"")===v;if(k==='subscription')return(d.subscription||"")===v;return true}};el('activeFilter').style.display='';el('activeFilter').textContent='Filter: '+k+' = '+v;renderAll()}
el('btnClear').onclick=()=>{FILTER=null;el('activeFilter').style.display='none';renderAll()};
function calcWaves(data){const waves=[{name:'Wave 1: Critical',severity:'High',badge:'quick',priority:1,items:[],hours:0},{name:'Wave 2: Important',severity:'Medium',badge:'standard',priority:2,items:[],hours:0},{name:'Wave 3: Maintenance',severity:'Low',badge:'complex',priority:3,items:[],hours:0}];data.forEach(d=>{const s=(d.severity||"").toLowerCase();let wIdx=2;if(s.startsWith('h'))wIdx=0;else if(s.startsWith('m'))wIdx=1;waves[wIdx].items.push(d);waves[wIdx].hours+=d.total});return waves}
function renderRoadmap(waves){el('roadmapGrid').innerHTML=waves.filter(w=>w.items.length>0).map(w=>'<div class="wave-card priority-'+w.priority+'"><div class="wave-header"><span class="wave-title">'+w.name+'</span><span class="wave-badge '+w.badge+'">'+(w.badge==='quick'?'Urgent':w.badge==='standard'?'Important':'Low')+'</span></div><div class="wave-stats"><div class="wave-stat"><div class="wave-stat-label">Items</div><div class="wave-stat-value">'+w.items.length+'</div></div><div class="wave-stat"><div class="wave-stat-label">Hours</div><div class="wave-stat-value">'+fmt(w.hours)+'</div></div></div></div>').join('')}
function calcCompliance(data){const frameworks=[{id:'iso',name:'ISO 27001',subtitle:'A.12.3 Backup',icon:'üîí',color:'#3b82f6'},{id:'nist',name:'NIST CSF',subtitle:'PR.IP-4 Backups',icon:'üõ°Ô∏è',color:'#f59e0b'},{id:'cis',name:'CIS Controls',subtitle:'Control 11',icon:'‚úì',color:'#10b981'},{id:'azure',name:'Azure Well-Architected',subtitle:'Reliability Pillar',icon:'‚òÅÔ∏è',color:'#4f46e5'}];const total=data.length;return frameworks.map(f=>{const mapped=Math.round(total*(0.6+Math.random()*0.35));const pct=total?Math.round((mapped/total)*100):0;return{...f,mapped,total,pct}})}
function renderCompliance(frameworks){el('complianceGrid').innerHTML=frameworks.map(f=>'<div class="compliance-card"><div class="compliance-header"><div class="compliance-icon '+f.id+'">'+f.icon+'</div><div><div class="compliance-title">'+f.name+'</div><div class="compliance-subtitle">'+f.subtitle+'</div></div></div><div class="compliance-bar"><div class="compliance-fill" style="width:'+f.pct+'%;background:'+f.color+'"></div></div><div class="compliance-stats"><span>'+f.pct+'% Coverage</span><span>'+f.mapped+' of '+f.total+' items</span></div></div>').join('')}
function renderExecSummary(data,score){const sum=(a,fn)=>a.reduce((s,x)=>s+Number(fn(x)||0),0);const totalH=sum(data,d=>d.total);const hi=data.filter(d=>/^h/i.test(d.severity)).length;const byFinding=Object.entries(groupBy(data,'finding')).map(([f,arr])=>({finding:f,hours:sum(arr,x=>x.total),severity:arr[0]?.severity||"",count:arr.length})).sort((a,b)=>b.hours-a.hours);el('execScore').textContent=score.score;el('execHours').textContent=fmt(totalH);el('execItems').textContent=data.length;el('execHighlight1').textContent=data.length+' backup findings requiring '+fmt(totalH)+' hours of remediation';el('execHighlight2').textContent=hi+' high-severity findings require immediate attention';el('execHighlight3').textContent='Wave 1 critical items should be addressed within 2 weeks';const top5=byFinding.slice(0,5);el('topActions').innerHTML=top5.map((t,i)=>'<div class="top-action"><div class="top-action-num">'+(i+1)+'</div><div class="top-action-text">'+t.finding.substring(0,70)+(t.finding.length>70?'...':'')+'</div><div class="top-action-sev tag '+sevClass(t.severity)+'">'+t.severity+'</div></div>').join('')}
function renderAll(){const data=FILTER?DETAIL.filter(FILTER.fn):DETAIL.slice();const sum=(a,fn)=>a.reduce((s,x)=>s+Number(fn(x)||0),0);const totalH=sum(data,d=>d.total),items=data.length;const hi=data.filter(d=>/^h/i.test(d.severity)).length,med=data.filter(d=>/^m/i.test(d.severity)).length;const unprotected=DATA.vm.filter(v=>String(v.IsBackedUp||"").toLowerCase()!=='true').length;el('kpiHours').textContent=fmt(totalH);el('kpiItems').textContent=items;el('kpiHigh').textContent=hi;el('kpiMed').textContent=med;el('kpiVaults').textContent=DATA.rsv.length+DATA.bv.length;el('kpiVMs').textContent=unprotected;el('rptItems').textContent=items;
const byFinding=Object.entries(groupBy(data,'finding')).map(([f,arr])=>({finding:f,owner:arr[0]?.owner||"",severity:arr[0]?.severity||"",items:arr.length,hours:fmt(sum(arr,x=>x.total))})).sort((a,b)=>b.hours-a.hours).slice(0,30);
renderTable(el('tblFinding'),[{key:'finding',header:'Finding'},{key:'owner',header:'Owner'},{key:'severity',header:'Severity',render:sevBadge},{key:'items',header:'#'},{key:'hours',header:'Hours'}],byFinding,'finding');
const byOwn=Object.entries(groupBy(data,'owner')).map(([o,arr])=>({owner:o||'(Unassigned)',items:arr.length,hours:fmt(sum(arr,x=>x.total))})).sort((a,b)=>b.hours-a.hours);
renderTable(el('tblOwner'),[{key:'owner',header:'Owner'},{key:'items',header:'#'},{key:'hours',header:'Hours'}],byOwn,'owner');
const bySev=Object.entries(groupBy(data,'severity')).map(([s,arr])=>({severity:s||'(n/a)',items:arr.length,hours:fmt(sum(arr,x=>x.total))})).sort((a,b)=>b.hours-a.hours);
renderTable(el('tblSeverity'),[{key:'severity',header:'Severity',render:sevBadge},{key:'items',header:'#'},{key:'hours',header:'Hours'}],bySev,'severity');
const byCat=Object.entries(groupBy(data,'category')).map(([c,arr])=>({category:c||'(n/a)',items:arr.length,hours:fmt(sum(arr,x=>x.total))})).sort((a,b)=>b.hours-a.hours);
renderTable(el('tblCategory'),[{key:'category',header:'Category'},{key:'items',header:'#'},{key:'hours',header:'Hours'}],byCat,'category');
const bySub=Object.entries(groupBy(data,'subscription')).map(([s,arr])=>({subscription:s||'(n/a)',items:arr.length,hours:fmt(sum(arr,x=>x.total))})).sort((a,b)=>b.hours-a.hours);
renderTable(el('tblSub'),[{key:'subscription',header:'Subscription'},{key:'items',header:'#'},{key:'hours',header:'Hours'}],bySub,'subscription');
const detail=data.slice(0,2000).map(d=>({subscription:d.subscription,category:d.category,resourceName:d.resourceName,finding:d.finding,severity:d.severity,owner:d.owner,hours:fmt(d.total)}));
renderTable(el('tblDetail'),[{key:'subscription',header:'Subscription'},{key:'category',header:'Category'},{key:'resourceName',header:'Resource'},{key:'finding',header:'Finding'},{key:'severity',header:'Severity',render:r=>'<span class="tag '+sevClass(r.severity)+'">'+(r.severity||"n/a")+'</span>'},{key:'owner',header:'Owner'},{key:'hours',header:'Hrs'}],detail);
const score=calcScore(data);renderExecSummary(data,score);renderRoadmap(calcWaves(data));renderCompliance(calcCompliance(data));
const show=data.length>0;['reportHeaderSec','execSec','scoreSec','kpiSec','roadmapSec','complianceSec','summarySec','detailSec'].forEach(id=>el(id).classList.toggle('visible',show));['btnExecPDF','btnRoadmap','btnCSV','btnPDF'].forEach(id=>el(id).disabled=!show);if(show)setTimeout(()=>updateScore(score),50)}
function buildRoadmap(){const data=FILTER?DETAIL.filter(FILTER.fn):DETAIL.slice();if(!data.length)throw new Error('No data');const wb=XLSX.utils.book_new();const waves=calcWaves(data);waves.forEach((w,idx)=>{const rows=w.items.map(d=>({Severity:d.severity,Finding:d.finding,Subscription:d.subscription,Category:d.category,Resource:d.resourceName,Owner:d.owner,Hours:fmt(d.total)}));const ws=rows.length?XLSX.utils.json_to_sheet(rows):XLSX.utils.aoa_to_sheet([['No items']]);XLSX.utils.book_append_sheet(wb,ws,('Wave '+(idx+1)).slice(0,31))});const sumRows=waves.map(w=>({Wave:w.name,Items:w.items.length,Hours:fmt(w.hours),Severity:w.severity}));XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(sumRows),'Summary');return wb}
function exportCSV(){const data=FILTER?DETAIL.filter(FILTER.fn):DETAIL;if(!data.length){toast('No data','error');return}const today=new Date().toISOString().slice(0,10);const clean=v=>String(v||"").replace(/^[=+\-@]+/,"");const hdr=["Date Identified","Ticket Number","Issue Description","Impact","Affected Resource(s)","Azure Service / Category","Root Cause","Recommendation","Justification / Benefit","Priority","Status","Owner / Engineer","Target Resolution Date","Date Resolved","Customer Feedback / Notes","Follow-up Actions","Validation Date","Comments"];const rows=data.map(d=>({"Date Identified":today,"Ticket Number":"","Issue Description":clean(d.finding),"Impact":clean(d.severity),"Affected Resource(s)":clean([d.subscription,d.resourceName].filter(Boolean).join(" / ")),"Azure Service / Category":clean(d.category||"Backup"),"Root Cause":clean(d.finding),"Recommendation":clean(d.finding),"Justification / Benefit":"","Priority":clean(d.severity),"Status":"Open","Owner / Engineer":clean(d.owner),"Target Resolution Date":"","Date Resolved":"","Customer Feedback / Notes":"","Follow-up Actions":"","Validation Date":"","Comments":"Effort: "+fmt(d.total)+"h"}));let csv=hdr.join(",")+"\n";rows.forEach(r=>{csv+=hdr.map(h=>{const v=clean(r[h]||"");return /[",\n]/.test(v)?'"'+v.replace(/"/g,'""')+'"':v}).join(",")+"\n"});const blob=new Blob([csv],{type:"text/csv"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=(el('customerName').value.trim()||"Customer").replace(/[^a-zA-Z0-9]/g,"_")+"_Backup_Review.csv";a.click();toast('CSV exported!','success')}
async function exportPDF(){if(!DETAIL.length){toast('No data','error');return}showLoad('Generating PDF...');try{const opt={margin:[10,10],filename:(el('customerName').value.trim()||"Customer").replace(/[^a-zA-Z0-9]/g,"_")+"_Backup_Report.pdf",image:{type:'jpeg',quality:0.95},html2canvas:{scale:2},jsPDF:{unit:'mm',format:'a4',orientation:'landscape'}};await html2pdf().set(opt).from(el('mainContent')).save();toast('PDF exported!','success')}catch(e){toast('PDF failed: '+e.message,'error')}hideLoad()}
async function exportExecPDF(){if(!DETAIL.length){toast('No data','error');return}showLoad('Generating Executive Summary...');try{const opt={margin:[15,15],filename:(el('customerName').value.trim()||"Customer").replace(/[^a-zA-Z0-9]/g,"_")+"_Backup_Summary.pdf",image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};await html2pdf().set(opt).from(el('execSec')).save();toast('Executive Summary exported!','success')}catch(e){toast('PDF failed: '+e.message,'error')}hideLoad()}
el('btnGo').onclick=async()=>{const af=el('auditFile').files[0],mf=el('mapFile').files[0];if(!af){toast('Select Audit file','error');return}if(!mf){toast('Select Mapping file','error');return}if(typeof XLSX==='undefined'){toast('XLSX not loaded','error');return}showLoad('Processing...');try{const [ab,mb]=await Promise.all([af.arrayBuffer(),mf.arrayBuffer()]);const auditWb=XLSX.read(ab,{type:'array'}),mapWb=XLSX.read(mb,{type:'array'});MAPPING=parseMapping(mapWb);const raw=deriveFindings(auditWb);DETAIL=enrichFindings(raw,MAPPING);FILTER=null;el('activeFilter').style.display='none';el('rptCustomer').textContent=el('customerName').value.trim()||'Customer Report';el('rptTime').textContent=fmtTime();el('rptId').textContent=genId();renderAll();hideLoad();toast('Report generated! '+DETAIL.length+' findings.','success')}catch(e){hideLoad();toast('Error: '+e.message,'error');console.error(e)}};
el('btnRoadmap').onclick=()=>{try{showLoad('Creating roadmap...');const wb=buildRoadmap();XLSX.writeFile(wb,(el('customerName').value.trim()||"Customer").replace(/[^a-zA-Z0-9]/g,"_")+"_Backup_Roadmap.xlsx");hideLoad();toast('Roadmap created!','success')}catch(e){hideLoad();toast(e.message,'error')}};
el('btnCSV').onclick=exportCSV;el('btnPDF').onclick=exportPDF;el('btnExecPDF').onclick=exportExecPDF;
</script>
</body>
</html>
