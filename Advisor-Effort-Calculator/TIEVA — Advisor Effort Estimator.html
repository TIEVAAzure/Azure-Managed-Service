<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TIEVA — Advisor Effort Estimator (Base Split Per Item)</title>

<style>
  :root{
    --brand-green:#2DA58E; --white:#FFFFFF;
    --critical:#ef4444; --moderate:#f59e0b; --excellent:#10b981;
    --bg:#ffffff; --fg:#111827; --muted:#6b7280; --border:#e5e7eb;
    --canvas: var(--brand-green); --link:#0f5eff; --content-max: 1440px;
  }
  *{box-sizing:border-box}
  html{scroll-behavior:smooth}
  body{margin:0;background:var(--canvas);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:var(--link);text-decoration:none}
  a:hover{text-decoration:underline}
  .wrap{max-width:var(--content-max);margin:0 auto;padding:24px}

  /* Header */
  .brandbar{background:#000;color:#fff}
  .brandwrap{max-width:var(--content-max);margin:0 auto;padding:14px 24px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brandtitle{font-size:18px;font-weight:600;letter-spacing:.2px}
  .btnrow{display:flex;gap:8px;flex-wrap:wrap}
  .header-btn{appearance:none;border:1px solid rgba(255,255,255,.25);background:transparent;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
  .header-btn:hover{border-color:#fff}

  /* Cards & layout */
  .row{display:flex;gap:20px;flex-wrap:wrap}
  .col{flex:1 1 360px}
  .card{background:#fff;border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:18px}
  h2{margin:0 0 10px;font-size:18px}
  h3{margin:0 0 10px;font-size:16px}
  .muted{color:var(--muted)}
  .pill{display:inline-block;font-size:12px;border-radius:999px;padding:2px 8px;border:1px solid var(--border)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:#f9fafb;cursor:pointer}
  .btn.primary{background:#0f5eff;color:#fff;border-color:#0f5eff}
  .file{display:flex;align-items:center;gap:8px}
  input[type=file]{border:1px solid var(--border);border-radius:8px;padding:6px 8px}
  .hint{font-size:12px;color:#374151;margin-top:8px}

  table{border-collapse:collapse;width:100%}
  th,td{border-bottom:1px solid var(--border);padding:6px 8px;text-align:left;font-size:13px;vertical-align:top}
  thead th{background:#fafafa}
  .scroller{max-height:520px;overflow:auto}

  /* KPI tiles */
  .tiles{display:flex;gap:12px;flex-wrap:wrap}
  .tile{flex:1 1 160px;border:1px solid var(--border);border-radius:10px;padding:12px;background:#fff}
  .tile h4{margin:0 0 6px;font-size:12px;color:#6b7280;text-transform:uppercase;letter-spacing:.3px}
  .tile .big{font-size:22px;font-weight:700}

  /* Full width sections (match Detail width) */
  #kpiSec, #summarySec, #vizSec, #decisionSec, #detailSec{ display:block }
  #kpiSec > .col, #summarySec > .col, #vizSec > .col, #decisionSec > .col, #detailSec > .col{ width:100%; flex:0 0 auto; max-width:none }
  #kpiSec .card, #summarySec .card, #vizSec .card, #decisionSec .card, #detailSec .card{ width:100% }

  /* Clickable rows */
  tbody tr[data-filter]{cursor:pointer}
  tbody tr[data-filter]:hover{background:#f5f7fb}
  .filterbar{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .key{font-size:12px;color:#374151;padding:4px 8px;border:1px solid var(--border);border-radius:8px;background:#f9fafb}

  /* Traffic-light tags */
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;color:#fff}
  .tag.high{background:var(--critical)}
  .tag.medium{background:var(--moderate)}
  .tag.low{background:var(--excellent)}
</style>

<!-- SheetJS (with fallbacks) -->
<script>
(function () {
  var tries = [
    "https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js",
    "https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
  ];
  function loadNext(i){
    if (window.XLSX || i>=tries.length) return;
    var s=document.createElement("script");
    s.src=tries[i]; s.async=true;
    s.onload=function(){ console.log("Loaded:", s.src); };
    s.onerror=function(){ console.warn("Failed:", s.src); loadNext(i+1); };
    document.head.appendChild(s);
  }
  loadNext(0);
})();
</script>

<!-- Chart.js (with fallbacks) -->
<script>
(function () {
  var tries = [
    "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js",
    "https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"
  ];
  function loadNext(i){
    if (window.Chart || i>=tries.length) return;
    var s=document.createElement("script");
    s.src=tries[i]; s.async=true;
    s.onload=function(){ console.log("Chart.js loaded:", s.src); };
    s.onerror=function(){ console.warn("Failed:", s.src); loadNext(i+1); };
    document.head.appendChild(s);
  }
  loadNext(0);
})();
</script>
</head>
<body>
  <div class="brandbar">
    <div class="brandwrap">
      <div class="brandtitle">TIEVA — Advisor Effort Estimator (Base split per item)</div>
      <div class="btnrow">
        <button id="btnCreateRoadmap" class="header-btn">Create Roadmap</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="pagetitle" style="color:#fff;font-weight:700">Decision view for remediation prioritisation</div>
    <div class="status" style="color:#fff;opacity:.95">
      Upload your Advisor CSV and the Effort workbook (exact match).
      <strong>Per item = (BaseHours ÷ items sharing the exact Recommendation) + PerResourceHours. Total = BaseHours + (PerResourceHours × items).</strong>
    </div>

    <!-- Uploaders -->
    <div class="card">
      <div class="row">
        <div class="col">
          <h3>1) Advisor export</h3>
          <div class="file"><input id="advisorFile" type="file" accept=".csv,text/csv" /></div>
          <div class="hint">CSV columns: <strong>Business Impact, Recommendation, Resource Group, Resource Name, Type</strong></div>
        </div>
        <div class="col">
          <h3>2) Effort workbook (Mapping)</h3>
          <div class="file"><input id="effortXlsx" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" /></div>
          <div class="hint">Sheet: <strong>Mapping</strong> with columns <em>Recommendation, EffortKey, ExampleDescription, BaseHours, PerResourceHours, Owner, DefaultRisk, ChangeWindowRequired, Controls</em>.</div>
        </div>
        <div class="col" style="display:flex;align-items:flex-end">
          <div class="toolbar">
            <button id="go" class="btn primary">Generate report</button>
            <button id="clearFilter" class="btn">Clear filter</button>
            <span id="status" class="muted" style="align-self:center"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div id="kpiSec" class="row" style="display:none">
      <div class="col card">
        <h2>At a glance</h2>
        <div class="tiles">
          <div class="tile">
            <h4>Total Remediation hours</h4>
            <div class="big" id="kpiHours">0</div>
          </div>
          <div class="tile">
            <h4>Total Exemption hours</h4>
            <div class="big" id="kpiExempt">0</div>
          </div>
          <div class="tile">
            <h4>Items</h4><div class="big" id="kpiItems">0</div>
          </div>
          <div class="tile">
            <h4>Unique Recommendations</h4><div class="big" id="kpiRecs">0</div>
          </div>
          <div class="tile">
            <h4>% Change Windows</h4><div class="big" id="kpiChange">0%</div>
          </div>
          <div class="tile">
            <h4>High-Risk Share</h4><div class="big" id="kpiHighRisk">0%</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SUMMARY TABLES -->
    <div id="summarySec" class="row" style="display:none">
      <div class="col card">
        <h2>Summary</h2>
        <div class="row">
          <div class="col">
            <h3>Top Effort by Recommendation</h3>
            <div id="tblRecEffort" class="scroller"></div>
          </div>
          <div class="col">
            <h3>By Owner</h3>
            <div id="tblOwner" class="scroller"></div>
          </div>
          <div class="col">
            <h3>By Risk</h3>
            <div id="tblRisk" class="scroller"></div>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <h3>By Change Window?</h3>
            <div id="tblChange" class="scroller"></div>
          </div>
          <div class="col">
            <h3>By Business Impact</h3>
            <div id="tblImpact" class="scroller"></div>
          </div>
          <div class="col">
            <h3>By Resource Type</h3>
            <div id="tblType" class="scroller"></div>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <h3>Effort buckets (per item)</h3>
            <div id="tblBuckets" class="scroller"></div>
          </div>
          <div class="col">
            <h3>Risk × Impact matrix</h3>
            <div id="tblMatrix" class="scroller"></div>
          </div>
          <div class="col">
            <h3>By Control</h3>
            <div id="tblControl" class="scroller"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- VISUALS -->
    <div id="vizSec" class="row" style="display:none">
      <div class="col card">
        <h2>Visuals</h2>
        <div class="row">
          <div class="col"><h3>Hours by Risk</h3><canvas id="chRiskHours" height="170"></canvas></div>
          <div class="col"><h3>Hours by Impact</h3><canvas id="chImpactHours" height="170"></canvas></div>
          <div class="col"><h3>Owner share</h3><canvas id="chOwnerShare" height="170"></canvas></div>
        </div>
        <div class="row">
          <div class="col"><h3>Top Recommendations (hours)</h3><canvas id="chRecTop" height="220"></canvas></div>
          <div class="col"><h3>Change Window</h3><canvas id="chChangeSplit" height="220"></canvas></div>
          <div class="col"><h3>Effort Buckets</h3><canvas id="chBuckets" height="220"></canvas></div>
        </div>
        <div id="vizMsg" class="muted" style="margin-top:6px;display:none">Charts require Chart.js; could not load the library.</div>
      </div>
    </div>

    <!-- DECISION LISTS -->
    <div id="decisionSec" class="row" style="display:none">
      <div class="col card">
        <h2>Decision helpers</h2>
        <div class="row">
          <div class="col">
            <h3>Quick Wins (High impact, low Risk)</h3>
            <div id="tblQuickWins" class="scroller"></div>
          </div>
          <div class="col">
            <h3>Big Bets (High impact, high hours)</h3>
            <div id="tblBigBets" class="scroller"></div>
          </div>
          <div class="col">
            <h3>Change-window heavy</h3>
            <div id="tblChangeHeavy" class="scroller"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- DETAILS -->
    <div id="detailSec" class="row" style="display:none">
      <div class="col card">
        <div class="filterbar">
          <h2 style="margin:0">Detail</h2>
          <span class="key">
            <strong>Key:</strong>
            Base is split evenly across items with the exact same Recommendation.
            Row Total = Per-Res + (Base ÷ item-count for that Recommendation).
            All summaries/charts reflect Base + (Per × count).
          </span>
          <span class="pill" id="activeFilter" style="display:none"></span>
        </div>
        <div id="tblDetail" class="scroller"></div>
      </div>
    </div>
  </div>

<script>
/* ---------- tiny helpers ---------- */
const $ = id => document.getElementById(id);
const fmt = n => isFinite(n) ? Math.round(n*10)/10 : 0;
const pct = (num,den) => den? Math.round((num/den)*100):0;
const norm = s => String(s||"").trim().replace(/\s+/g," ").replace(/\.*$/," ").toLowerCase();
const COLORS = { high:'#ef4444', medium:'#f59e0b', low:'#10b981', blue:'#3b82f6', gray:'#9ca3af', green:'#22c55e' };

function status(t){ $("status").textContent = t||""; }

/* --- simple CSV (quoted) --- */
function parseCSV(text){
  const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(x=>x.length);
  if(!lines.length) return [];
  const hdr = splitCSVLine(lines[0]);
  const out=[];
  for(let i=1;i<lines.length;i++){
    const row = splitCSVLine(lines[i]);
    const obj={}; hdr.forEach((h,idx)=>obj[h]=row[idx]??"");
    out.push(obj);
  }
  return out;
}
function splitCSVLine(s){
  const row=[]; let cur="", q=false;
  for(let i=0;i<s.length;i++){
    const c=s[i];
    if(q){
      if(c=='"'){ if(s[i+1]=='"'){cur+='"'; i++;} else {q=false;} }
      else cur+=c;
    }else{
      if(c=='"') q=true;
      else if(c==","){ row.push(cur); cur=""; }
      else cur+=c;
    }
  }
  row.push(cur);
  return row.map(x=>x??"");
}

/* table renderer with optional column render() */
function renderTable(el, columns, rows, clickKey){
  let html='<table><thead><tr>';
  columns.forEach(c=> html+=`<th>${c.header}</th>`);
  html+='</tr></thead><tbody>';
  rows.forEach(r=>{
    const val = clickKey ? r[clickKey] : null;
    const attr = (clickKey && val!=null) ? ` data-filter="${clickKey}" data-value="${encodeURIComponent(val)}"` : '';
    html+=`<tr${attr}>`;
    columns.forEach(c=>{
      let cell = c.render ? c.render(r) : (r[c.key]??"");
      html+=`<td>${cell}</td>`;
    });
    html+='</tr>';
  });
  html+='</tbody></table>';
  el.innerHTML = html;
  if(clickKey){
    el.querySelectorAll('tbody tr[data-filter]').forEach(tr=>{
      tr.addEventListener('click', ()=> {
        const key = tr.getAttribute('data-filter');
        const val = decodeURIComponent(tr.getAttribute('data-value')||"");
        applyFilter(key, val);
      });
    });
  }
}

function groupBy(arr, key){
  const m={}; arr.forEach(x=>{ const k=x[key]??""; (m[k]??=[]).push(x); }); return m;
}
function riskClass(v){
  const s=(v||"").toString().toLowerCase();
  if(s.startsWith('h')) return 'high';
  if(s.startsWith('m')) return 'medium';
  if(s.startsWith('l')) return 'low';
  return '';
}

/* ---------- Excel: read Mapping sheet ---------- */
function getCI(obj, key){
  const target = String(key).toLowerCase();
  for(const k of Object.keys(obj)){ if(String(k).toLowerCase()===target) return obj[k]; }
  return undefined;
}
function parseWorkbook(wb){
  const mapSheet = wb.Sheets["Mapping"];
  if(!mapSheet) throw new Error('Workbook must have a sheet named "Mapping".');

  const mapRows = XLSX.utils.sheet_to_json(mapSheet, {defval:""});

  const mapping = {}; // key: normalized Recommendation
  mapRows.forEach(r=>{
    const rec = String(getCI(r,"Recommendation")||"").trim();
    if(!rec) return;
    const key = norm(rec);
    mapping[key] = {
      effortKey: getCI(r,"EffortKey")||"",
      example: getCI(r,"ExampleDescription")||"",
      base: Number(getCI(r,"BaseHours")||0),
      per: Number(getCI(r,"PerResourceHours")||0),
      owner: getCI(r,"Owner")||"",
      risk: getCI(r,"DefaultRisk")||"",
      change: getCI(r,"ChangeWindowRequired")||"",
      controls: getCI(r,"Controls") || ""     // NEW
    };
  });

  return {mapping};
}

/* ---------- Normalize Advisor rows ---------- */
function normalizeAdvisorRows(rows){
  return rows.map(r=>({
    businessImpact: r["Business Impact"]||r["Impact"]||"",
    recommendation: r["Recommendation"]||"",
    resourceGroup:  r["Resource Group"]||"",
    resourceName:   r["Resource Name"]||"",
    type:           r["Type"]||r["Resource Type"]||""
  })).filter(x=>String(x.recommendation||"").trim()!=="");
}

/* ---------- Effort calculation: BASE SPLIT ACROSS ITEMS (amortized) ---------- */
function estimate(detailRows, mapping){
  // Enrich
  const rows = detailRows.map(ad=>{
    const key = norm(ad.recommendation);
    const m = mapping[key] || null;

    return {
      businessImpact:ad.businessImpact,
      recommendation:ad.recommendation,
      resourceGroup:ad.resourceGroup,
      resourceName:ad.resourceName,
      type:ad.type,
      effortKey: m ? (m.effortKey||"") : "Unmapped - Review",
      owner: m ? (m.owner||"") : "",
      risk:  m ? (m.risk||"")  : "",
      change:m ? (m.change||"") : "",
      control: m ? (m.controls||"") : "",   // NEW
      baseConfigured: m ? Number(m.base||0) : 0,   // configured base for the rec (B)
      per:  m ? Number(m.per||0)  : 0,             // per-resource hours (P)
      baseShown: 0,                                 // per-item share B/N displayed on each row
      totalHours: 0                                 // (B/N) + P
    };
  });

  // Group strictly by exact Recommendation text
  const groups = {};
  rows.forEach(r=>{
    const gk = "REC:" + norm(r.recommendation);
    (groups[gk]??=[]).push(r);
  });

  // For each recommendation group, spread Base evenly across items: basePer = B / N
  Object.values(groups).forEach(arr=>{
    if(arr.length===0) return;
    const base = Number(arr[0].baseConfigured||0); // B
    const per  = Number(arr[0].per||0);            // P
    const n    = arr.length;                       // N
    const basePer = n > 0 ? (base / n) : 0;        // B/N

    arr.forEach(r=>{
      r.baseShown  = basePer;             // show B/N on every row
      r.totalHours = per + basePer;       // per-item total = P + (B/N)
    });
  });

  return rows;
}

/* ---------- Filter handling ---------- */
let DETAIL = [];
let FILTER = null;
function applyFilter(key, value){
  const label = `${key}: ${value || "(blank)"}`;
  FILTER = {
    key, value,
    fn: (d)=>{
      switch(key){
        case "effortKey":   return (d.effortKey||"")===value;
        case "owner":       return (d.owner||"")===value;
        case "risk":        return (d.risk||"")===value;
        case "change":      return (d.change||"")===value;
        case "businessImpact": return (d.businessImpact||"")===value;
        case "type":        return (d.type||"")===value;
        case "control":     return (d.control||"")===value;          // NEW
        case "bucket":      return bucketOf(d)===value;
        case "matrix": {
          const mk = (String(d.risk||"").trim() + "|" + String(d.businessImpact||"").trim()).toLowerCase();
          return mk === String(value||"").trim().toLowerCase();
        }
        case "recommendation": return norm(d.recommendation)===norm(value);
        default: return true;
      }
    }
  };
  $("activeFilter").style.display = "";
  $("activeFilter").textContent = "Filter: " + label;
  renderAll();
}
$("clearFilter").addEventListener("click", ()=>{ FILTER=null; $("activeFilter").style.display="none"; renderAll(); });

/* ---------- Decision helpers ---------- */
function bucketOf(d){
  const perItem = Number(d.totalHours||0); // equals P + (B/N)
  if (perItem < 0.5) return "S (<0.5h)";
  if (perItem < 2.0) return "M (0.5–2h)";
  return "L (≥2h)";
}

/* ---------- Charts ---------- */
let CHARTS = [];
function destroyCharts(){ CHARTS.forEach(c=>{try{c.destroy()}catch(e){}}); CHARTS=[]; }
function makeChart(id, cfg){
  if(!window.Chart){ $("vizMsg").style.display=''; return; }
  $("vizMsg").style.display='none';
  const ctx = $(id).getContext('2d');
  const chart = new Chart(ctx, cfg);
  CHARTS.push(chart);
  return chart;
}

/* ===== Roadmap helpers (Custom order + Wave names + Summary) ===== */
function normLMH(val){
  const v = String(val||"").trim().toLowerCase();
  if (v.startsWith("h")) return "High";
  if (v.startsWith("m")) return "Medium";
  if (v.startsWith("l")) return "Low";
  return "(n/a)";
}
function pickRows(data, wantRisk, wantImpact){
  const R = String(wantRisk||"").toLowerCase();
  const I = String(wantImpact||"").toLowerCase();
  return data
    .filter(d => normLMH(d.risk).toLowerCase() === R &&
                 normLMH(d.businessImpact).toLowerCase() === I)
    .map(d => ({
      BusinessImpact: normLMH(d.businessImpact),
      Risk:           normLMH(d.risk),
      Recommendation: d.recommendation,
      Owner:          d.owner || "",
      ChangeWindow:   d.change || "",
      Control:        d.control || "",
      ResourceGroup:  d.resourceGroup || "",
      ResourceName:   d.resourceName || "",
      Type:           d.type || "",
      BaseShare_h:    fmt(d.baseShown),
      PerResource_h:  fmt(d.per),
      Total_h:        fmt(d.totalHours)
    }));
}
function makeSheetFromRows(rows){
  if (!rows.length) return XLSX.utils.aoa_to_sheet([["No items"]]);
  const headers = Object.keys(rows[0]);
  const data = [headers].concat(rows.map(r => headers.map(h => r[h])));
  return XLSX.utils.aoa_to_sheet(data);
}

// Desired export order + wave names
const COMBOS_IN_ORDER = [
  {risk:"Low",    impact:"High",   name:"Low x High"},
  {risk:"Low",    impact:"Medium", name:"Low x Medium"},
  {risk:"Low",    impact:"Low",    name:"Low x Low"},
  {risk:"Medium", impact:"High",   name:"Medium x High"},
  {risk:"Medium", impact:"Medium", name:"Medium x Medium"},
  {risk:"Medium", impact:"Low",    name:"Medium x Low"},
  {risk:"High",   impact:"High",   name:"High x High"},
  {risk:"High",   impact:"Medium", name:"High x Medium"},
  {risk:"High",   impact:"Low",    name:"High x Low"}
];

function buildSummarySheet(data){
  // Matrix in standard order
  const risks   = ["High","Medium","Low"];
  const impacts = ["High","Medium","Low"];

  const metrics = {};
  risks.forEach(r => impacts.forEach(i => {
    const rows = data.filter(d => normLMH(d.risk)===r && normLMH(d.businessImpact)===i);
    const items = rows.length;
    const hours = rows.reduce((s,x)=>s+Number(x.totalHours||0),0);
    metrics[`${r}|${i}`] = {items, hours};
  }));

  const mtx = [["Risk \\ Impact"].concat(impacts).concat(["Row Items","Row Hours"])];
  risks.forEach(r=>{
    const rowItems = impacts.map(i => metrics[`${r}|${i}`].items);
    const rowHours = impacts.map(i => metrics[`${r}|${i}`].hours);
    mtx.push([r].concat(rowItems).concat([
      rowItems.reduce((a,b)=>a+b,0),
      Math.round(rowHours.reduce((a,b)=>a+b,0)*10)/10
    ]));
  });
  const colItemsTotals = impacts.map((i,idx)=> risks.reduce((s,r)=> s + mtx[1+risks.indexOf(r)][1+idx], 0));
  const colHoursTotals = impacts.map(i=> risks.reduce((s,r)=> s + metrics[`${r}|${i}`].hours, 0));
  mtx.push(["Col Totals"].concat(colItemsTotals).concat([
    colItemsTotals.reduce((a,b)=>a+b,0),
    Math.round(colHoursTotals.reduce((a,b)=>a+b,0)*10)/10
  ]));

  // Flat table in required order with Wave numbers
  const flat = [["Wave","Combo","Items","Hours","Avg h/item"]];
  COMBOS_IN_ORDER.forEach((c,idx)=>{
    const key = `${c.risk}|${c.impact}`;
    const items = metrics[key]?.items || 0;
    const hours = metrics[key]?.hours || 0;
    flat.push([`Wave ${idx+1}`, c.name, items, Math.round(hours*10)/10, items? Math.round((hours/items)*10)/10 : "—"]);
  });

  const ws = XLSX.utils.aoa_to_sheet([["Risk × Impact — Items & Hours (matrix)"]]);
  XLSX.utils.sheet_add_aoa(ws, [[]], {origin:-1});
  XLSX.utils.sheet_add_aoa(ws, mtx, {origin:-1});
  XLSX.utils.sheet_add_aoa(ws, [[]], {origin:-1});
  XLSX.utils.sheet_add_aoa(ws, [["Wave Plan — Ordered Combos"]], {origin:-1});
  XLSX.utils.sheet_add_aoa(ws, flat, {origin:-1});
  return ws;
}

function buildRoadmapWorkbook(){
  if (typeof XLSX === 'undefined'){ throw new Error("XLSX library failed to load."); }
  const data = FILTER ? DETAIL.filter(FILTER.fn) : DETAIL.slice();
  if (!data.length) { throw new Error("Generate report first."); }

  const wb = XLSX.utils.book_new();

  // Summary first
  XLSX.utils.book_append_sheet(wb, buildSummarySheet(data), "Summary");

  // 9 tabs in the exact order, with Wave names
  COMBOS_IN_ORDER.forEach((c, idx)=>{
    const rows = pickRows(data, c.risk, c.impact);
    const ws = makeSheetFromRows(rows);
    const tab = (`Wave ${idx+1} - ${c.name}`).slice(0,31); // Excel tab name limit
    XLSX.utils.book_append_sheet(wb, ws, tab);
  });

  return wb;
}

/* ---------- Render orchestration ---------- */
function renderAll(){
  const data = FILTER ? DETAIL.filter(FILTER.fn) : DETAIL.slice();

  // Totals
  const totalH = data.reduce((s,d)=>s+Number(d.totalHours||0),0);
  const items = data.length;
  const uniqueRecs = new Set(data.map(d=>d.recommendation)).size;
  const changeYes = data.filter(d=>String(d.change||"").toLowerCase().startsWith("y")).length;
  const highRisk = data.filter(d=>String(d.risk||"").toLowerCase().startsWith("h")).length;

  // KPIs
  $("kpiHours").textContent = fmt(totalH);
  $("kpiExempt").textContent = fmt(totalH * 0.01);
  $("kpiItems").textContent = items;
  $("kpiRecs").textContent = uniqueRecs;
  $("kpiChange").textContent = pct(changeYes, items) + "%";
  $("kpiHighRisk").textContent = pct(highRisk, items) + "%";

  const sum = (arr,sel)=>arr.reduce((s,x)=>s+Number(sel(x)||0),0);
  const riskBadge = row => `<span class="tag ${riskClass(row.risk)}">${row.risk||"(n/a)"}</span>`;

  // Summary tables — hours use row.totalHours (P + B/N)
  const byRec = Object.entries(groupBy(data,"recommendation")).map(([rec,arr])=>({
    recommendation: rec,
    owner: (arr[0]&&arr[0].owner)||"",
    risk: (arr[0]&&arr[0].risk)||"",
    items: arr.length,
    hours: fmt(sum(arr,x=>x.totalHours))
  })).sort((a,b)=>b.hours-a.hours).slice(0,100);

  const byOwn = Object.entries(groupBy(data,"owner")).map(([o,arr])=>({
    owner:o||"(Unassigned)", items:arr.length, hours:fmt(sum(arr,x=>x.totalHours))
  })).sort((a,b)=>b.hours-a.hours);

  const byRisk = Object.entries(groupBy(data,"risk")).map(([r,arr])=>({
    risk:r||"(n/a)", items:arr.length, hours:fmt(sum(arr,x=>x.totalHours))
  })).sort((a,b)=>b.hours-a.hours);

  const byChg = Object.entries(groupBy(data,"change")).map(([c,arr])=>({
    change:c||"(n/a)", items:arr.length, hours:fmt(sum(arr,x=>x.totalHours))
  })).sort((a,b)=>b.hours-a.hours);

  const byImp = Object.entries(groupBy(data,"businessImpact")).map(([i,arr])=>({
    impact:i||"(n/a)", items:arr.length, hours:fmt(sum(arr,x=>x.totalHours))
  })).sort((a,b)=>b.hours-a.hours);

  const byType = Object.entries(groupBy(data,"type")).map(([t,arr])=>({
    type:t||"(n/a)", items:arr.length, hours:fmt(sum(arr,x=>x.totalHours))
  })).sort((a,b)=>b.hours-a.hours);

  const byControl = Object.entries(groupBy(data,"control")).map(([c,arr])=>({
    control: c || "(n/a)",
    items: arr.length,
    hours: fmt(sum(arr,x=>x.totalHours))
  })).sort((a,b)=> b.hours - a.hours);

  // Buckets
  const buckets = {};
  data.forEach(d=>{ const b=bucketOf(d); (buckets[b]??=[]).push(d); });
  const rowsBuckets = Object.entries(buckets).map(([b,arr])=>({
    bucket:b, items:arr.length, hours:fmt(sum(arr,x=>x.totalHours))
  })).sort((a,b)=>a.bucket.localeCompare(b.bucket));

  // Risk x Impact matrix
  const M = {};
  data.forEach(d=>{
    const r = (d.risk||"").trim();
    const i = (d.businessImpact||"").trim();
    const k = r + "|" + i;
    (M[k] ??= []).push(d);
  });
  const rowsMatrix = Object.entries(M).map(([k,arr])=>{
    const [r,i] = k.split("|");
    const hours = sum(arr,x=>x.totalHours);
    return { matrix:k, label:`${r||"(n/a)"} × ${i||"(n/a)"}`, items:arr.length, hours:fmt(hours) };
  }).sort((a,b)=>b.hours-a.hours);

  // Render summary tables
  renderTable($("tblRecEffort"),
    [{key:"recommendation",header:"Recommendation"},
     {key:"owner",header:"Owner"},
     {key:"risk",header:"Risk", render: riskBadge},
     {key:"items",header:"# Items"},
     {key:"hours",header:"Hours"}],
    byRec, "recommendation");

  renderTable($("tblOwner"),
    [{key:"owner",header:"Owner"},
     {key:"items",header:"# Items"},
     {key:"hours",header:"Hours"}],
    byOwn, "owner");

  renderTable($("tblRisk"),
    [{key:"risk",header:"Risk", render: riskBadge},
     {key:"items",header:"# Items"},
     {key:"hours",header:"Hours"}],
    byRisk, "risk");

  renderTable($("tblChange"),
    [{key:"change",header:"Change Window?"},
     {key:"items",header:"# Items"},
     {key:"hours",header:"Hours"}],
    byChg, "change");

  renderTable($("tblImpact"),
    [{key:"impact",header:"Business Impact"},
     {key:"items",header:"# Items"},
     {key:"hours",header:"Hours"}],
    byImp, "businessImpact");

  renderTable($("tblType"),
    [{key:"type",header:"Type"},
     {key:"items",header:"# Items"},
     {key:"hours",header:"Hours"}],
    byType, "type");

  renderTable($("tblBuckets"),
    [{key:"bucket",header:"Bucket"},
     {key:"items",header:"# Items"},
     {key:"hours",header:"Hours"}],
    rowsBuckets, "bucket");

  renderTable($("tblMatrix"),
    [{key:"label",header:"Risk × Impact"},
     {key:"items",header:"# Items"},
     {key:"hours",header:"Hours"}],
    rowsMatrix, "matrix");

  renderTable($("tblControl"),
    [{key:"control",header:"Control"},
     {key:"items",header:"# Items"},
     {key:"hours",header:"Hours"}],
    byControl, "control");

  // ---- Decision lists (grouped by exact Recommendation) ----
  const byRecForDecisions = Object.entries(groupBy(data,"recommendation")).map(([rec,arr])=>{
    const impact = (arr[0]?.businessImpact)||"";
    const hours  = sum(arr,x=>x.totalHours);
    const avg    = hours / arr.length; // equals P + (B/N)
    const owner  = (arr[0]?.owner)||"";
    const risk   = (arr[0]?.risk)||"";
    const change = (arr[0]?.change)||"";
    return {recommendation:rec, impact, items:arr.length, hours:fmt(hours), avg:fmt(avg), owner, risk, change};
  });
// High impact (same as before)
const highImpact = byRecForDecisions.filter(r => /^high\b/i.test(r.impact || ""));

// Quick Wins = High impact + Low risk
const quickWinsCand = highImpact.filter(r => /^low\b/i.test(r.risk || ""));

// Optional: tie-breaker order (smallest total hours first)
const quickWins = (quickWinsCand.length ? quickWinsCand : byRecForDecisions)
  .sort((a,b) => a.hours - b.hours)
  .slice(0,12);

// (leave Big Bets as-is, it still uses hours)
const BIG_BET_AVG_MIN = 1.0;


  const bigBetsCand = highImpact.filter(r=>r.avg >= BIG_BET_AVG_MIN);
  const bigBets = (bigBetsCand.length ? bigBetsCand
                    : (highImpact.length ? highImpact : byRecForDecisions))
    .sort((a,b)=>b.hours - a.hours)
    .slice(0,12);

  const changeHeavy = byRecForDecisions
    .filter(r=>String(r.change).toLowerCase().startsWith("y"))
    .sort((a,b)=>b.hours - a.hours)
    .slice(0,12);

  const colsQB = [
    {key:"recommendation",header:"Recommendation"},
    {key:"items",header:"#"},
    {key:"avg",header:"Avg hrs"},
    {key:"hours",header:"Total"},
    {key:"owner",header:"Owner"},
    {key:"risk",header:"Risk", render: r=>`<span class=\"tag ${riskClass(r.risk)}\">${r.risk||"(n/a)"}</span>`}
  ];
  renderTable($("tblQuickWins"), colsQB, quickWins, "recommendation");
  renderTable($("tblBigBets"),   colsQB, bigBets,   "recommendation");
  renderTable($("tblChangeHeavy"), [
    {key:"recommendation",header:"Recommendation"},
    {key:"items",header:"#"},
    {key:"hours",header:"Total"},
    {key:"owner",header:"Owner"},
    {key:"risk",header:"Risk", render: r=>`<span class=\"tag ${riskClass(r.risk)}\">${r.risk||"(n/a)"}</span>`}
  ], changeHeavy, "recommendation");

  // Detail table — include Control
  const prev = data.slice(0,5000).map(d=>({
    BusinessImpact:d.businessImpact,
    Recommendation:d.recommendation,
    ResourceGroup:d.resourceGroup,
    ResourceName:d.resourceName,
    Type:d.type,
    EffortKey:d.effortKey,
    Owner:d.owner,
    Risk:`<span class=\"tag ${riskClass(d.risk)}\">${d.risk||"(n/a)"}</span>`,
    Change:d.change,
    Control:d.control,                 // NEW
    BaseShare:fmt(d.baseShown),        // B/N on every row
    PerRes:fmt(d.per),
    Total:fmt(d.totalHours)            // P + (B/N)
  }));
  renderTable($("tblDetail"), [
    {key:'BusinessImpact',header:'Business Impact'},
    {key:'Recommendation',header:'Recommendation'},
    {key:'ResourceGroup',header:'Resource Group'},
    {key:'ResourceName',header:'Resource Name'},
    {key:'Type',header:'Type'},
    {key:'EffortKey',header:'EffortKey'},
    {key:'Owner',header:'Owner'},
    {key:'Risk',header:'Risk', render: r=>r.Risk},
    {key:'Change',header:'Change Window?'},
    {key:'Control',header:'Control'},   // NEW
    {key:'BaseShare',header:'Base (B÷N) (h)'},
    {key:'PerRes',header:'Per-Res (h)'},
    {key:'Total',header:'Total (h)'}
  ], prev);

  // ---- Charts ----
  $("vizSec").style.display='';
  destroyCharts();
  if(!window.Chart){ $("vizMsg").style.display=''; }
  else {
    // Risk hours
    const riskHours = {High:0, Medium:0, Low:0, Other:0};
    data.forEach(d=>{
      const r=(d.risk||"").toLowerCase();
      const h=Number(d.totalHours||0);
      if(r.startsWith('h')) riskHours.High+=h;
      else if(r.startsWith('m')) riskHours.Medium+=h;
      else if(r.startsWith('l')) riskHours.Low+=h;
      else riskHours.Other=(riskHours.Other||0)+h;
    });
    makeChart('chRiskHours', {
      type:'bar',
      data:{
        labels:['High','Medium','Low'].concat(riskHours.Other?['Other']:[]),
        datasets:[{label:'Hours', data:[riskHours.High,riskHours.Medium,riskHours.Low].concat(riskHours.Other?[riskHours.Other]:[]),
          backgroundColor:['#ef4444','#f59e0b','#10b981'].concat(riskHours.Other?['#94a3b8']:[])}]
      },
      options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    // Impact hours
    const impMap = {}; data.forEach(d=>{ const k=d.businessImpact||'(n/a)'; impMap[k]=(impMap[k]||0)+Number(d.totalHours||0); });
    const impLabels = Object.keys(impMap);
    const impColors = impLabels.map(l=>{
      const v = l.toLowerCase();
      if(v.startsWith('h')) return '#ef4444';
      if(v.startsWith('m')) return '#f59e0b';
      if(v.startsWith('l')) return '#10b981';
      return '#94a3b8';
    });
    makeChart('chImpactHours', {
      type:'bar',
      data:{ labels:impLabels, datasets:[{label:'Hours',data:impLabels.map(l=>impMap[l]), backgroundColor:impColors}]},
      options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    // Owner share (top 8 + other)
    const ownerMap = {}; data.forEach(d=>{ const k=d.owner||'(Unassigned)'; ownerMap[k]=(ownerMap[k]||0)+Number(d.totalHours||0); });
    const ownerPairs = Object.entries(ownerMap).sort((a,b)=>b[1]-a[1]);
    const top8 = ownerPairs.slice(0,8); const other = ownerPairs.slice(8).reduce((s,[,v])=>s+v,0);
    const ownerLabels = top8.map(x=>x[0]).concat(other?['Other']:[]);
    const ownerVals = top8.map(x=>x[1]).concat(other?[other]:[]);
    makeChart('chOwnerShare', {
      type:'doughnut',
      data:{ labels:ownerLabels, datasets:[{ data:ownerVals }]},
      options:{responsive:true,plugins:{legend:{position:'bottom'}}}
    });

    // Top Recommendations by hours (top 10)
    const recMap = {}; data.forEach(d=>{ const k=d.recommendation||'(n/a)'; recMap[k]=(recMap[k]||0)+Number(d.totalHours||0); });
    const recTop = Object.entries(recMap).sort((a,b)=>b[1]-a[1]).slice(0,10);
    makeChart('chRecTop', {
      type:'bar',
      data:{ labels:recTop.map(x=>x[0]), datasets:[{ label:'Hours', data:recTop.map(x=>x[1]), backgroundColor:'#0ea5e9' }]},
      options:{indexAxis:'y', responsive:true,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true}}}
    });

    // Change split
    const chYes = data.filter(d=>String(d.change||"").toLowerCase().startsWith('y')).reduce((s,x)=>s+Number(x.totalHours||0),0);
    const chNo  = totalH - chYes;
    makeChart('chChangeSplit', {
      type:'doughnut',
      data:{ labels:['Yes','No'], datasets:[{ data:[chYes,chNo], backgroundColor:[COLORS.blue, COLORS.gray] }]},
      options:{responsive:true,plugins:{legend:{position:'bottom'}}}
    });

    // Buckets
    const buckMap = {}; data.forEach(d=>{ const b=bucketOf(d); buckMap[b]=(buckMap[b]||0)+Number(d.totalHours||0); });
    const buckLabels = Object.keys(buckMap);
    makeChart('chBuckets', {
      type:'bar',
      data:{ labels:buckLabels, datasets:[{ label:'Hours', data:buckLabels.map(k=>buckMap[k]), backgroundColor:'#6366f1' }]},
      options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
  }

  const show = data.length>0 ? '' : 'none';
  $("kpiSec").style.display=show;
  $("summarySec").style.display=show;
  $("decisionSec").style.display=show;
  $("detailSec").style.display=show;
}

/* ---------- Wire up ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  $("go").addEventListener('click', async ()=>{
    status('');
    try{
      const csvFile = $("advisorFile").files[0];
      const xlsFile = $("effortXlsx").files[0];
      if(!csvFile){ status('Choose the Advisor CSV.'); return; }
      if(!xlsFile){ status('Choose the Effort workbook (.xlsx).'); return; }
      if(typeof XLSX === 'undefined'){ status('XLSX library failed to load.'); return; }

      const [csvText, xlsArray] = await Promise.all([csvFile.text(), xlsFile.arrayBuffer()]);
      const advObjs = parseCSV(csvText);
      const adv = normalizeAdvisorRows(advObjs);

      const wb = XLSX.read(xlsArray, {type:'array'});
      const {mapping} = parseWorkbook(wb);

      DETAIL = estimate(adv, mapping);
      FILTER = null;
      $("activeFilter").style.display="none";
      renderAll();
      status('Report generated.');
    }catch(err){
      console.error(err);
      status('Error: ' + (err?.message||err));
    }
  });

  $("btnCreateRoadmap").addEventListener("click", ()=>{
    try{
      const wb = buildRoadmapWorkbook();
      XLSX.writeFile(wb, "advisor_roadmap.xlsx");
      status("Roadmap created.");
    }catch(err){
      console.error(err);
      alert(err?.message || err);
    }
  });
});
</script>
</body>
</html>
