<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TIEVA — Advisor Effort Estimator</title>
<style>
:root{--tieva-teal:#2DA58E;--tieva-navy:#1B365D;--critical:#ef4444;--warning:#f59e0b;--success:#10b981;--fg:#111827;--muted:#6b7280;--border:#e5e7eb;--canvas:var(--tieva-teal);--content-max:1440px}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--canvas);color:var(--fg);font:14px/1.5 'Segoe UI',system-ui,sans-serif}
.wrap{max-width:var(--content-max);margin:0 auto;padding:24px}
.brandbar{background:var(--tieva-navy);color:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.15)}
.brandwrap{max-width:var(--content-max);margin:0 auto;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
.brandtitle{font-size:20px;font-weight:700}
.brandsubtitle{font-size:12px;opacity:0.85;margin-top:2px}
.btnrow{display:flex;gap:8px;flex-wrap:wrap}
.header-btn{border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.1);color:#fff;border-radius:6px;padding:8px 14px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s}
.header-btn:hover{background:rgba(255,255,255,.25)}
.header-btn:disabled{opacity:0.5;cursor:not-allowed}
.pagetitle{font-size:26px;font-weight:700;color:#fff;margin-bottom:8px}
.pagedesc{font-size:14px;color:rgba(255,255,255,0.9);margin-bottom:20px}
.row{display:flex;gap:20px;flex-wrap:wrap}
.col{flex:1 1 360px}
.card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
h2{margin:0 0 14px;font-size:18px;color:var(--tieva-navy)}
h3{margin:0 0 12px;font-size:16px;color:var(--tieva-navy)}
.muted{color:var(--muted)}
.btn{padding:10px 16px;border:1px solid var(--border);border-radius:8px;background:#f9fafb;cursor:pointer;font-size:13px;font-weight:500}
.btn:hover{background:#f3f4f6}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.btn.primary{background:var(--tieva-teal);color:#fff;border-color:var(--tieva-teal)}
.btn.primary:hover:not(:disabled){background:#1a6b5a}
input[type=file]{border:2px dashed var(--border);border-radius:8px;padding:12px;background:#f9fafb;cursor:pointer;width:100%}
input[type=file]:hover{border-color:var(--tieva-teal);background:#f0fdf4}
input[type=text]{border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-size:14px;width:100%}
input[type=text]:focus{outline:none;border-color:var(--tieva-teal)}
label{font-weight:600;font-size:13px;display:block;margin-bottom:6px}
.hint{font-size:12px;color:var(--muted);margin-top:4px}

/* Posture Score Ring */
.score-container{display:flex;align-items:center;gap:24px;padding:24px;background:linear-gradient(135deg,#f8fafc,#f1f5f9);border-radius:12px;margin-bottom:20px}
.score-ring{position:relative;width:140px;height:140px;flex-shrink:0}
.score-ring svg{transform:rotate(-90deg);width:140px;height:140px}
.score-ring circle{fill:none;stroke-width:12}
.score-ring .bg{stroke:#e5e7eb}
.score-ring .progress{stroke-linecap:round;transition:stroke-dashoffset 0.8s ease}
.score-value{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.score-value .number{font-size:36px;font-weight:700;color:var(--tieva-navy)}
.score-value .label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
.score-details{flex:1}
.score-details h3{margin:0 0 8px;font-size:20px}
.score-details p{margin:0 0 12px;color:var(--muted);font-size:14px;line-height:1.5}
.score-badge{display:inline-block;padding:6px 14px;border-radius:999px;font-size:13px;font-weight:600}
.score-badge.critical{background:#fee2e2;color:#dc2626}
.score-badge.warning{background:#fef3c7;color:#d97706}
.score-badge.good{background:#d1fae5;color:#059669}
.score-badge.excellent{background:#dbeafe;color:#1d4ed8}

/* Report Header */
.report-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;padding:20px;background:#fff;border-radius:12px;border-left:4px solid var(--tieva-teal)}
.report-header .customer-name{font-size:24px;font-weight:700;color:var(--tieva-navy)}
.report-header .report-type{font-size:14px;color:var(--muted);margin-top:4px}
.report-header .report-meta{text-align:right;font-size:13px;color:var(--muted)}
.report-header .report-meta div{margin-bottom:6px}
.report-header .report-meta strong{color:var(--fg)}

/* KPI Tiles */
.tiles{display:flex;gap:14px;flex-wrap:wrap}
.tile{flex:1 1 150px;border:1px solid var(--border);border-radius:10px;padding:16px;background:#fff}
.tile h4{margin:0 0 8px;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;font-weight:600}
.tile .big{font-size:28px;font-weight:700;color:var(--tieva-navy)}

/* Tables */
table{border-collapse:collapse;width:100%}
thead{background:var(--tieva-teal);color:#fff}
th{text-align:left;padding:10px 12px;font-weight:600;font-size:12px;text-transform:uppercase}
td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:top}
tbody tr:hover{background:#f9fafb}
tbody tr[data-filter]{cursor:pointer}
tbody tr[data-filter]:hover{background:#f0fdf4}
.scroller{max-height:480px;overflow:auto}

/* Tags */
.tag{display:inline-block;padding:3px 10px;border-radius:999px;font-size:11px;font-weight:600;color:#fff}
.tag.high{background:var(--critical)}
.tag.medium{background:var(--warning)}
.tag.low{background:var(--success)}
.pill{display:inline-block;font-size:12px;border-radius:999px;padding:4px 10px;border:1px solid var(--border);background:#f9fafb}
.filterbar{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}

/* Section visibility */
.section{display:none}
.section.visible{display:block}

/* Loading Overlay */
.loading-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.95);z-index:9999;justify-content:center;align-items:center;flex-direction:column;gap:20px}
.loading-overlay.active{display:flex}
.spinner{width:56px;height:56px;border:5px solid var(--border);border-top-color:var(--tieva-teal);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:18px;color:var(--tieva-navy);font-weight:600}

/* Toast Notifications */
.toast-container{position:fixed;top:24px;right:24px;z-index:10000;display:flex;flex-direction:column;gap:12px}
.toast{background:#fff;border-radius:10px;padding:16px 20px;box-shadow:0 8px 24px rgba(0,0,0,0.15);animation:slideIn 0.3s ease;max-width:420px;display:flex;align-items:center;gap:12px}
.toast.success{border-left:4px solid var(--success)}
.toast.error{border-left:4px solid var(--critical)}
.toast.info{border-left:4px solid var(--tieva-teal)}
@keyframes slideIn{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}

/* Print */
@media print{
.brandbar,.header-btn,.btn,input,.loading-overlay,.toast-container,#uploadCard{display:none!important}
.wrap{padding:0;max-width:100%}
.card{box-shadow:none;page-break-inside:avoid}
.section.visible{display:block!important}
body{background:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact}
.score-container{-webkit-print-color-adjust:exact;print-color-adjust:exact}
}
</style>
<script>
(function(){var t=["https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js","https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"];function l(i){if(window.XLSX||i>=t.length)return;var s=document.createElement("script");s.src=t[i];s.async=true;s.onload=function(){console.log("XLSX loaded")};s.onerror=function(){l(i+1)};document.head.appendChild(s)}l(0)})();
(function(){var t=["https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js","https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"];function l(i){if(window.Chart||i>=t.length)return;var s=document.createElement("script");s.src=t[i];s.async=true;s.onload=function(){console.log("Chart.js loaded")};s.onerror=function(){l(i+1)};document.head.appendChild(s)}l(0)})();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><div class="loading-text" id="loadingText">Generating report...</div></div>
<div class="toast-container" id="toastContainer"></div>

<div class="brandbar">
<div class="brandwrap">
<div><div class="brandtitle">TIEVA — Advisor Effort Estimator</div><div class="brandsubtitle">Azure Advisor Remediation Prioritisation Tool</div></div>
<div class="btnrow">
<button id="btnRoadmap" class="header-btn" disabled>Create Roadmap</button>
<button id="btnCSV" class="header-btn" disabled>Export to Customer Review</button>
<button id="btnPDF" class="header-btn" disabled>Export PDF Report</button>
<button id="btnHTML" class="header-btn">Export HTML</button>
</div>
</div>
</div>

<div class="wrap" id="mainContent">
<div class="pagetitle">Advisor Remediation Prioritisation</div>
<div class="pagedesc">Upload your Azure Advisor CSV export and Effort Mapping workbook to generate remediation estimates and prioritisation roadmap.</div>

<!-- Upload Card -->
<div class="card" id="uploadCard">
<div class="row">
<div class="col"><label for="customerName">Customer Name</label><input type="text" id="customerName" placeholder="Enter customer name for report header"/></div>
</div>
<div class="row" style="margin-top:16px">
<div class="col"><label>1) Advisor Export (CSV)</label><input id="advisorFile" type="file" accept=".csv"/><div class="hint">Columns: Business Impact, Recommendation, Resource Group, Resource Name, Type</div></div>
<div class="col"><label>2) Effort Mapping (XLSX)</label><input id="effortXlsx" type="file" accept=".xlsx"/><div class="hint">Sheet: Mapping with Recommendation, BaseHours, PerResourceHours, Owner, DefaultRisk</div></div>
<div class="col" style="display:flex;align-items:flex-end"><div style="display:flex;gap:10px"><button id="btnGo" class="btn primary">Generate Report</button><button id="btnClear" class="btn">Clear Filter</button></div></div>
</div>
</div>

<!-- Report Header -->
<div id="reportHeaderSec" class="section">
<div class="report-header">
<div><div class="customer-name" id="rptCustomer">Customer Report</div><div class="report-type">Azure Advisor Remediation Analysis</div></div>
<div class="report-meta"><div><strong>Generated:</strong> <span id="rptTime"></span></div><div><strong>Items Analyzed:</strong> <span id="rptItems">0</span></div><div><strong>Report ID:</strong> <span id="rptId"></span></div></div>
</div>
</div>

<!-- Posture Score -->
<div id="scoreSec" class="section">
<div class="score-container">
<div class="score-ring">
<svg viewBox="0 0 140 140"><circle class="bg" cx="70" cy="70" r="58"/><circle class="progress" id="scoreCircle" cx="70" cy="70" r="58" stroke-dasharray="364" stroke-dashoffset="364"/></svg>
<div class="score-value"><div class="number" id="scoreNum">0</div><div class="label">Score</div></div>
</div>
<div class="score-details">
<h3>Advisor Compliance Score</h3>
<p id="scoreDesc">Upload your data to calculate your Azure Advisor compliance score based on recommendation coverage and risk distribution.</p>
<span class="score-badge" id="scoreBadge">Pending</span>
</div>
</div>
</div>

<!-- KPIs -->
<div id="kpiSec" class="section">
<div class="card">
<h2>At a Glance</h2>
<div class="tiles">
<div class="tile"><h4>Total Remediation Hours</h4><div class="big" id="kpiHours">0</div></div>
<div class="tile"><h4>Exemption Hours</h4><div class="big" id="kpiExempt">0</div></div>
<div class="tile"><h4>Items</h4><div class="big" id="kpiItems">0</div></div>
<div class="tile"><h4>Unique Recommendations</h4><div class="big" id="kpiRecs">0</div></div>
<div class="tile"><h4>% Change Windows</h4><div class="big" id="kpiChange">0%</div></div>
<div class="tile"><h4>High-Risk Share</h4><div class="big" id="kpiHigh">0%</div></div>
</div>
</div>
</div>

<!-- Summary Tables -->
<div id="summarySec" class="section">
<div class="card">
<h2>Summary</h2>
<div class="row">
<div class="col"><h3>Top Effort by Recommendation</h3><div id="tblRec" class="scroller"></div></div>
<div class="col"><h3>By Owner</h3><div id="tblOwner" class="scroller"></div></div>
<div class="col"><h3>By Risk</h3><div id="tblRisk" class="scroller"></div></div>
</div>
<div class="row" style="margin-top:20px">
<div class="col"><h3>By Change Window</h3><div id="tblChange" class="scroller"></div></div>
<div class="col"><h3>By Business Impact</h3><div id="tblImpact" class="scroller"></div></div>
<div class="col"><h3>By Resource Type</h3><div id="tblType" class="scroller"></div></div>
</div>
</div>
</div>

<!-- Charts -->
<div id="vizSec" class="section">
<div class="card">
<h2>Visuals</h2>
<div class="row">
<div class="col"><h3>Hours by Risk</h3><canvas id="chRisk" height="180"></canvas></div>
<div class="col"><h3>Hours by Impact</h3><canvas id="chImpact" height="180"></canvas></div>
<div class="col"><h3>Owner Share</h3><canvas id="chOwner" height="180"></canvas></div>
</div>
</div>
</div>

<!-- Decision Helpers -->
<div id="decisionSec" class="section">
<div class="card">
<h2>Decision Helpers</h2>
<div class="row">
<div class="col"><h3>Quick Wins (High Impact, Low Risk)</h3><div id="tblQuick" class="scroller"></div></div>
<div class="col"><h3>Big Bets (High Impact, High Hours)</h3><div id="tblBig" class="scroller"></div></div>
<div class="col"><h3>Change-Window Heavy</h3><div id="tblCW" class="scroller"></div></div>
</div>
</div>
</div>

<!-- Detail -->
<div id="detailSec" class="section">
<div class="card">
<div class="filterbar"><h2 style="margin:0">Detail</h2><span class="pill" id="activeFilter" style="display:none"></span></div>
<div id="tblDetail" class="scroller"></div>
</div>
</div>
</div>

<script>
const $=id=>document.getElementById(id);
const fmt=n=>isFinite(n)?Math.round(n*10)/10:0;
const pct=(n,d)=>d?Math.round(n/d*100):0;
const norm=s=>String(s||"").trim().replace(/\s+/g," ").toLowerCase();

let DETAIL=[],MAPPING={},FILTER=null,CHARTS=[];

// Toast
function toast(msg,type='info',dur=4000){
  const c=$('toastContainer'),t=document.createElement('div');
  t.className='toast '+type;t.innerHTML='<span>'+msg+'</span>';
  c.appendChild(t);setTimeout(()=>t.remove(),dur);
}

// Loading
function showLoad(txt){$('loadingText').textContent=txt;$('loadingOverlay').classList.add('active')}
function hideLoad(){$('loadingOverlay').classList.remove('active')}

// Report ID
function genId(){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';let id='ADV-';for(let i=0;i<8;i++)id+=c[Math.floor(Math.random()*c.length)];return id}

// Timestamp
function fmtTime(d=new Date()){return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'})}

// CSV Parser
function parseCSV(t){
  const lines=t.replace(/\r\n/g,"\n").split("\n").filter(x=>x.trim());
  if(!lines.length)return[];
  const hdr=splitLine(lines[0]),out=[];
  for(let i=1;i<lines.length;i++){const r=splitLine(lines[i]),o={};hdr.forEach((h,j)=>o[h]=r[j]||"");out.push(o)}
  return out;
}
function splitLine(s){const r=[];let c="",q=false;for(let i=0;i<s.length;i++){const ch=s[i];if(q){if(ch=='"'){if(s[i+1]=='"'){c+='"';i++}else q=false}else c+=ch}else{if(ch=='"')q=true;else if(ch==','){r.push(c);c=""}else c+=ch}}r.push(c);return r}

// Table
function renderTable(el,cols,rows,ck){
  let h='<table><thead><tr>';cols.forEach(c=>h+='<th>'+c.header+'</th>');h+='</tr></thead><tbody>';
  rows.forEach(r=>{
    const v=ck?r[ck]:null,a=(ck&&v!=null)?' data-filter="'+ck+'" data-value="'+encodeURIComponent(v)+'"':'';
    h+='<tr'+a+'>';cols.forEach(c=>h+='<td>'+(c.render?c.render(r):(r[c.key]||""))+'</td>');h+='</tr>';
  });
  h+='</tbody></table>';el.innerHTML=h;
  if(ck)el.querySelectorAll('tr[data-filter]').forEach(tr=>tr.addEventListener('click',()=>applyFilter(tr.getAttribute('data-filter'),decodeURIComponent(tr.getAttribute('data-value')))));
}

function groupBy(a,k){const m={};a.forEach(x=>{const key=x[k]||"";(m[key]=m[key]||[]).push(x)});return m}
function riskClass(v){const s=(v||"").toLowerCase();return s.startsWith('h')?'high':s.startsWith('m')?'medium':s.startsWith('l')?'low':''}
function riskBadge(r){return '<span class="tag '+riskClass(r.risk)+'">'+(r.risk||"n/a")+'</span>'}

// Excel Parser
function getCI(o,k){const t=k.toLowerCase();for(const x of Object.keys(o))if(x.toLowerCase()===t)return o[x];return undefined}
function parseWB(wb){
  const sh=wb.Sheets["Mapping"];if(!sh)throw new Error('Need sheet "Mapping"');
  const rows=XLSX.utils.sheet_to_json(sh,{defval:""}),map={};
  rows.forEach(r=>{
    const rec=String(getCI(r,"Recommendation")||"").trim();if(!rec)return;
    map[norm(rec)]={base:Number(getCI(r,"BaseHours")||0),per:Number(getCI(r,"PerResourceHours")||0),owner:getCI(r,"Owner")||"",risk:getCI(r,"DefaultRisk")||"",change:getCI(r,"ChangeWindowRequired")||"",whyEnable:getCI(r,"WhyEnableIt")||""};
  });
  return map;
}

// Normalize Advisor
function normAdvisor(rows){
  return rows.map(r=>({impact:r["Business Impact"]||"",rec:r["Recommendation"]||"",rg:r["Resource Group"]||"",rn:r["Resource Name"]||"",type:r["Type"]||""})).filter(x=>x.rec.trim());
}

// Estimate
function estimate(adv,map){
  const rows=adv.map(a=>{const k=norm(a.rec),m=map[k]||null;return{...a,owner:m?.owner||"",risk:m?.risk||"",change:m?.change||"",whyEnable:m?.whyEnable||"",baseCfg:m?.base||0,per:m?.per||0,baseShow:0,total:0}});
  const grp={};rows.forEach(r=>{const g=norm(r.rec);(grp[g]=grp[g]||[]).push(r)});
  Object.values(grp).forEach(arr=>{const b=arr[0].baseCfg,p=arr[0].per,n=arr.length,bp=n?b/n:0;arr.forEach(r=>{r.baseShow=bp;r.total=p+bp})});
  return rows;
}

// Posture Score
function calcScore(data){
  if(!data.length)return{score:0,label:'No Data',cls:'critical'};
  const n=data.length,hi=data.filter(d=>/^h/i.test(d.risk)).length,med=data.filter(d=>/^m/i.test(d.risk)).length;
  let s=100-(hi/n)*50-(med/n)*25;s=Math.max(0,Math.min(100,Math.round(s)));
  let l,c;if(s>=80){l='Excellent';c='excellent'}else if(s>=60){l='Good';c='good'}else if(s>=40){l='Needs Attention';c='warning'}else{l='Critical';c='critical'}
  return{score:s,label:l,cls:c};
}
function updateScore(sc){
  const circ=364,off=circ-(sc.score/100)*circ;
  $('scoreCircle').style.strokeDashoffset=off;
  $('scoreCircle').style.stroke=sc.score>=80?'#10b981':sc.score>=60?'#3b82f6':sc.score>=40?'#f59e0b':'#ef4444';
  $('scoreNum').textContent=sc.score;
  $('scoreBadge').textContent=sc.label;
  $('scoreBadge').className='score-badge '+sc.cls;
  const desc={excellent:'Excellent compliance. Focus on maintenance.',good:'Good progress. Address high-risk items.',warning:'Attention needed. Review decision helpers.',critical:'Critical findings require immediate action.'};
  $('scoreDesc').textContent=desc[sc.cls];
}

// Filter
function applyFilter(k,v){
  FILTER={key:k,value:v,fn:d=>{
    if(k==='rec')return norm(d.rec)===norm(v);
    if(k==='owner')return(d.owner||"")===v;
    if(k==='risk')return(d.risk||"")===v;
    if(k==='change')return(d.change||"")===v;
    if(k==='impact')return(d.impact||"")===v;
    if(k==='type')return(d.type||"")===v;
    return true;
  }};
  $('activeFilter').style.display='';$('activeFilter').textContent='Filter: '+k+' = '+v;
  renderAll();
}
$('btnClear').onclick=()=>{FILTER=null;$('activeFilter').style.display='none';renderAll()};

// Charts
function destroyCharts(){CHARTS.forEach(c=>{try{c.destroy()}catch(e){}});CHARTS=[]}
function makeChart(id,cfg){if(!window.Chart)return;const ch=new Chart($(id).getContext('2d'),cfg);CHARTS.push(ch);return ch}

// Render All
function renderAll(){
  const data=FILTER?DETAIL.filter(FILTER.fn):DETAIL.slice();
  const sum=(a,fn)=>a.reduce((s,x)=>s+Number(fn(x)||0),0);
  const totalH=sum(data,d=>d.total),items=data.length,uniq=new Set(data.map(d=>d.rec)).size;
  const chgY=data.filter(d=>/^y/i.test(d.change)).length,hiRisk=data.filter(d=>/^h/i.test(d.risk)).length;

  $('kpiHours').textContent=fmt(totalH);
  $('kpiExempt').textContent=fmt(totalH*0.01);
  $('kpiItems').textContent=items;
  $('kpiRecs').textContent=uniq;
  $('kpiChange').textContent=pct(chgY,items)+'%';
  $('kpiHigh').textContent=pct(hiRisk,items)+'%';
  $('rptItems').textContent=items;

  // By Rec
  const byRec=Object.entries(groupBy(data,'rec')).map(([r,arr])=>({rec:r,owner:arr[0]?.owner||"",risk:arr[0]?.risk||"",items:arr.length,hours:fmt(sum(arr,x=>x.total))})).sort((a,b)=>b.hours-a.hours).slice(0,50);
  renderTable($('tblRec'),[{key:'rec',header:'Recommendation'},{key:'owner',header:'Owner'},{key:'risk',header:'Risk',render:riskBadge},{key:'items',header:'#'},{key:'hours',header:'Hours'}],byRec,'rec');

  // By Owner
  const byOwn=Object.entries(groupBy(data,'owner')).map(([o,arr])=>({owner:o||'(Unassigned)',items:arr.length,hours:fmt(sum(arr,x=>x.total))})).sort((a,b)=>b.hours-a.hours);
  renderTable($('tblOwner'),[{key:'owner',header:'Owner'},{key:'items',header:'#'},{key:'hours',header:'Hours'}],byOwn,'owner');

  // By Risk
  const byRisk=Object.entries(groupBy(data,'risk')).map(([r,arr])=>({risk:r||'(n/a)',items:arr.length,hours:fmt(sum(arr,x=>x.total))})).sort((a,b)=>b.hours-a.hours);
  renderTable($('tblRisk'),[{key:'risk',header:'Risk',render:riskBadge},{key:'items',header:'#'},{key:'hours',header:'Hours'}],byRisk,'risk');

  // By Change
  const byChg=Object.entries(groupBy(data,'change')).map(([c,arr])=>({change:c||'(n/a)',items:arr.length,hours:fmt(sum(arr,x=>x.total))})).sort((a,b)=>b.hours-a.hours);
  renderTable($('tblChange'),[{key:'change',header:'Change?'},{key:'items',header:'#'},{key:'hours',header:'Hours'}],byChg,'change');

  // By Impact
  const byImp=Object.entries(groupBy(data,'impact')).map(([i,arr])=>({impact:i||'(n/a)',items:arr.length,hours:fmt(sum(arr,x=>x.total))})).sort((a,b)=>b.hours-a.hours);
  renderTable($('tblImpact'),[{key:'impact',header:'Impact'},{key:'items',header:'#'},{key:'hours',header:'Hours'}],byImp,'impact');

  // By Type
  const byType=Object.entries(groupBy(data,'type')).map(([t,arr])=>({type:t||'(n/a)',items:arr.length,hours:fmt(sum(arr,x=>x.total))})).sort((a,b)=>b.hours-a.hours);
  renderTable($('tblType'),[{key:'type',header:'Type'},{key:'items',header:'#'},{key:'hours',header:'Hours'}],byType,'type');

  // Decision helpers
  const byRecDec=Object.entries(groupBy(data,'rec')).map(([r,arr])=>({rec:r,impact:arr[0]?.impact||"",items:arr.length,hours:fmt(sum(arr,x=>x.total)),avg:fmt(sum(arr,x=>x.total)/arr.length),owner:arr[0]?.owner||"",risk:arr[0]?.risk||"",change:arr[0]?.change||""}));
  const hiImp=byRecDec.filter(r=>/^high/i.test(r.impact));
  const quick=(hiImp.filter(r=>/^low/i.test(r.risk)).length?hiImp.filter(r=>/^low/i.test(r.risk)):byRecDec).sort((a,b)=>a.hours-b.hours).slice(0,10);
  const big=(hiImp.filter(r=>r.avg>=1).length?hiImp.filter(r=>r.avg>=1):hiImp.length?hiImp:byRecDec).sort((a,b)=>b.hours-a.hours).slice(0,10);
  const cw=byRecDec.filter(r=>/^y/i.test(r.change)).sort((a,b)=>b.hours-a.hours).slice(0,10);
  const decCols=[{key:'rec',header:'Recommendation'},{key:'items',header:'#'},{key:'avg',header:'Avg'},{key:'hours',header:'Total'},{key:'owner',header:'Owner'},{key:'risk',header:'Risk',render:riskBadge}];
  renderTable($('tblQuick'),decCols,quick,'rec');
  renderTable($('tblBig'),decCols,big,'rec');
  renderTable($('tblCW'),decCols,cw,'rec');

  // Detail
  const detail=data.slice(0,3000).map(d=>({impact:d.impact,rec:d.rec,rg:d.rg,rn:d.rn,type:d.type,owner:d.owner,risk:d.risk,change:d.change,hours:fmt(d.total)}));
  renderTable($('tblDetail'),[{key:'impact',header:'Impact'},{key:'rec',header:'Recommendation'},{key:'rg',header:'RG'},{key:'rn',header:'Resource'},{key:'type',header:'Type'},{key:'owner',header:'Owner'},{key:'risk',header:'Risk',render:r=>'<span class="tag '+riskClass(r.risk)+'">'+(r.risk||"n/a")+'</span>'},{key:'change',header:'Chg?'},{key:'hours',header:'Hrs'}],detail);

  // Charts
  destroyCharts();
  if(window.Chart){
    const riskH={High:0,Medium:0,Low:0};data.forEach(d=>{const r=(d.risk||"").toLowerCase();if(r.startsWith('h'))riskH.High+=d.total;else if(r.startsWith('m'))riskH.Medium+=d.total;else if(r.startsWith('l'))riskH.Low+=d.total});
    makeChart('chRisk',{type:'bar',data:{labels:['High','Medium','Low'],datasets:[{data:[riskH.High,riskH.Medium,riskH.Low],backgroundColor:['#ef4444','#f59e0b','#10b981']}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});

    const impM={};data.forEach(d=>{const k=d.impact||'(n/a)';impM[k]=(impM[k]||0)+d.total});
    makeChart('chImpact',{type:'bar',data:{labels:Object.keys(impM),datasets:[{data:Object.values(impM),backgroundColor:Object.keys(impM).map(l=>l.toLowerCase().startsWith('h')?'#ef4444':l.toLowerCase().startsWith('m')?'#f59e0b':'#10b981')}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});

    const ownM={};data.forEach(d=>{const k=d.owner||'(Unassigned)';ownM[k]=(ownM[k]||0)+d.total});
    const ownTop=Object.entries(ownM).sort((a,b)=>b[1]-a[1]).slice(0,6);
    makeChart('chOwner',{type:'doughnut',data:{labels:ownTop.map(x=>x[0]),datasets:[{data:ownTop.map(x=>x[1])}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});
  }

  // Show sections
  const show=data.length>0;
  ['reportHeaderSec','scoreSec','kpiSec','summarySec','vizSec','decisionSec','detailSec'].forEach(id=>$(id).classList.toggle('visible',show));
  if(show)updateScore(calcScore(data));
  ['btnRoadmap','btnCSV','btnPDF'].forEach(id=>$(id).disabled=!show);
}

// Roadmap Builder
function buildRoadmap(){
  const data=FILTER?DETAIL.filter(FILTER.fn):DETAIL.slice();
  if(!data.length)throw new Error('No data');
  const wb=XLSX.utils.book_new();
  const combos=[{r:'Low',i:'High'},{r:'Low',i:'Medium'},{r:'Low',i:'Low'},{r:'Medium',i:'High'},{r:'Medium',i:'Medium'},{r:'Medium',i:'Low'},{r:'High',i:'High'},{r:'High',i:'Medium'},{r:'High',i:'Low'}];
  combos.forEach((c,idx)=>{
    const rows=data.filter(d=>{const dr=(d.risk||"").toLowerCase(),di=(d.impact||"").toLowerCase();return dr.startsWith(c.r.toLowerCase())&&di.startsWith(c.i.toLowerCase())}).map(d=>({Impact:d.impact,Risk:d.risk,Recommendation:d.rec,Owner:d.owner,ResourceGroup:d.rg,ResourceName:d.rn,Type:d.type,Hours:fmt(d.total)}));
    const ws=rows.length?XLSX.utils.json_to_sheet(rows):XLSX.utils.aoa_to_sheet([['No items']]);
    XLSX.utils.book_append_sheet(wb,ws,('Wave '+(idx+1)+' - '+c.r+'x'+c.i).slice(0,31));
  });
  return wb;
}

// Export CSV
function exportCSV(){
  const data=FILTER?DETAIL.filter(FILTER.fn):DETAIL;
  if(!data.length){toast('No data','error');return}
  const today=new Date().toISOString().slice(0,10);
  const clean=v=>String(v||"").replace(/^[=+\-@]+/,"").replace(/^-\s*/,"");
  const hdr=["Date Identified","Ticket Number","Issue Description","Impact","Affected Resource(s)","Azure Service / Category","Root Cause","Recommendation","Justification / Benefit","Priority","Status","Owner / Engineer","Target Resolution Date","Date Resolved","Customer Feedback / Notes","Follow-up Actions","Validation Date","Comments"];
  const rows=data.map(d=>({
    "Date Identified":today,"Ticket Number":"","Issue Description":clean(d.rec),"Impact":clean(d.impact),
    "Affected Resource(s)":clean([d.rg,d.rn].filter(Boolean).join(" / ")),"Azure Service / Category":clean(d.type||"Azure Advisor"),
    "Root Cause":clean(d.rec),"Recommendation":clean(d.rec),"Justification / Benefit":clean(d.whyEnable||""),
    "Priority":clean(d.risk),"Status":"Open","Owner / Engineer":clean(d.owner),"Target Resolution Date":"",
    "Date Resolved":"","Customer Feedback / Notes":"","Follow-up Actions":"","Validation Date":"","Comments":"Effort: "+fmt(d.total)+"h"
  }));
  let csv=hdr.join(",")+"\n";
  rows.forEach(r=>{csv+=hdr.map(h=>{const v=clean(r[h]||"");return /[",\n]/.test(v)?'"'+v.replace(/"/g,'""')+'"':v}).join(",")+"\n"});
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);
  a.download=($('customerName').value.trim()||"Customer").replace(/[^a-zA-Z0-9]/g,"_")+"_Advisor_Review.csv";
  a.click();toast('CSV exported!','success');
}

// Export PDF
async function exportPDF(){
  if(!DETAIL.length){toast('No data','error');return}
  showLoad('Generating PDF...');
  try{
    const opt={margin:[10,10],filename:($('customerName').value.trim()||"Customer").replace(/[^a-zA-Z0-9]/g,"_")+"_Advisor_Report.pdf",image:{type:'jpeg',quality:0.95},html2canvas:{scale:2},jsPDF:{unit:'mm',format:'a4',orientation:'landscape'}};
    await html2pdf().set(opt).from($('mainContent')).save();
    toast('PDF exported!','success');
  }catch(e){toast('PDF failed: '+e.message,'error')}
  hideLoad();
}

// Main
$('btnGo').onclick=async()=>{
  const csvF=$('advisorFile').files[0],xlsF=$('effortXlsx').files[0];
  if(!csvF){toast('Select Advisor CSV','error');return}
  if(!xlsF){toast('Select Mapping XLSX','error');return}
  if(typeof XLSX==='undefined'){toast('XLSX not loaded','error');return}
  showLoad('Processing...');
  try{
    const [csvT,xlsB]=await Promise.all([csvF.text(),xlsF.arrayBuffer()]);
    const adv=normAdvisor(parseCSV(csvT));
    if(!adv.length){hideLoad();toast('No valid rows','error');return}
    MAPPING=parseWB(XLSX.read(xlsB,{type:'array'}));
    DETAIL=estimate(adv,MAPPING);
    FILTER=null;$('activeFilter').style.display='none';
    $('rptCustomer').textContent=$('customerName').value.trim()||'Customer Report';
    $('rptTime').textContent=fmtTime();
    $('rptId').textContent=genId();
    renderAll();
    hideLoad();toast('Report generated! '+DETAIL.length+' items.','success');
  }catch(e){hideLoad();toast('Error: '+e.message,'error');console.error(e)}
};

$('btnRoadmap').onclick=()=>{try{showLoad('Creating roadmap...');const wb=buildRoadmap();XLSX.writeFile(wb,($('customerName').value.trim()||"Customer").replace(/[^a-zA-Z0-9]/g,"_")+"_Roadmap.xlsx");hideLoad();toast('Roadmap created!','success')}catch(e){hideLoad();toast(e.message,'error')}};
$('btnCSV').onclick=exportCSV;
$('btnPDF').onclick=exportPDF;
$('btnHTML').onclick=()=>{const h='<!doctype html>'+document.documentElement.outerHTML;const b=new Blob([h],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=($('customerName').value.trim()||"TIEVA").replace(/[^a-zA-Z0-9]/g,"_")+"_Advisor_Report.html";a.click();toast('HTML exported!','success')};
</script>
</body>
</html>
