<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TIEVA - Identity & Access Analyzer</title>
<style>
  :root{
    --brand-green:#2DA58E; --critical:#ef4444; --moderate:#f59e0b; --excellent:#10b981;
    --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --canvas: var(--brand-green);
    --link:#0f5eff; --content-max: 1440px;
  }
  *{box-sizing:border-box}
  html{scroll-behavior:smooth}
  body{
    margin:0;
    background:var(--canvas);
    color:var(--fg);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }
  a{color:var(--link);text-decoration:none}
  a:hover{text-decoration:underline}
  .wrap{max-width:var(--content-max);margin:0 auto;padding:24px}
  .brandbar{background:#000;color:#fff}
  .brandwrap{
    max-width:var(--content-max);
    margin:0 auto;
    padding:14px 24px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .brandtitle{font-size:18px;font-weight:600}
  .btnrow{display:flex;gap:8px;flex-wrap:wrap}
  .header-btn{
    appearance:none;
    border:1px solid rgba(255,255,255,.25);
    background:transparent;
    color:#fff;
    border-radius:8px;
    padding:8px 12px;
    cursor:pointer;
    font-size:13px;
  }
  .header-btn:hover{border-color:#fff}
  .row{display:flex;gap:20px;flex-wrap:wrap}
  .col{flex:1 1 360px}
  .card{
    background:#fff;
    border:1px solid var(--border);
    border-radius:10px;
    padding:16px;
    margin:18px 0;
  }
  h2{margin:0 0 10px;font-size:18px}
  h3{margin:0 0 10px;font-size:16px}
  h4{margin:0 0 6px;font-size:13px}
  .muted{color:var(--muted)}
  .pill{
    display:inline-block;
    font-size:12px;
    border-radius:999px;
    padding:2px 8px;
    border:1px solid var(--border);
    background:#f9fafb;
  }
  .btn{
    padding:8px 12px;
    border:1px solid var(--border);
    border-radius:8px;
    background:#f9fafb;
    cursor:pointer;
    font-size:13px;
  }
  .btn.primary{
    background:#0f5eff;
    color:#fff;
    border-color:#0f5eff;
  }
  input[type=file]{
    border:1px solid var(--border);
    border-radius:8px;
    padding:6px 8px;
    width:100%;
  }
  table{border-collapse:collapse;width:100%}
  thead th{background:#fafafa}
  th,td{
    border-bottom:1px solid var(--border);
    padding:6px 8px;
    text-align:left;
    font-size:13px;
    vertical-align:top;
  }
  .scroller{max-height:520px;overflow:auto}
  .tiles{display:flex;gap:12px;flex-wrap:wrap}
  .tile{
    flex:1 1 160px;
    border:1px solid var(--border);
    border-radius:10px;
    padding:12px;
    background:#fff;
  }
  .tile h4{
    margin:0 0 6px;
    font-size:12px;
    color:#6b7280;
    text-transform:uppercase;
    letter-spacing:.3px;
  }
  .tile .big{font-size:22px;font-weight:700}
  tbody tr[data-filter]{cursor:pointer}
  tbody tr[data-filter]:hover{background:#f5f7fb}
  .filterbar{
    display:flex;
    gap:8px;
    align-items:center;
    margin-bottom:8px;
    flex-wrap:wrap;
  }
  .key{
    font-size:12px;
    color:#374151;
    padding:4px 8px;
    border:1px solid var(--border);
    border-radius:8px;
    background:#f9fafb;
  }
  .tag{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-size:12px;
    color:#fff;
    white-space:nowrap;
  }
  .tag.high{background:var(--critical)}
  .tag.medium{background:var(--moderate)}
  .tag.low{background:var(--excellent)}
  .tag.info{background:#3b82f6}
  .hidden{display:none!important}
  .status{color:#fff;opacity:.95;margin-bottom:12px}
  .pagetitle{color:#fff;font-weight:700;font-size:16px;margin-bottom:4px}
  .badge-type{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;background:#e0e7ff;color:#3730a3}
</style>
<script>
(function(){var t=["https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js","https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js","https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"];function l(i){if(window.XLSX||i>=t.length)return;var s=document.createElement("script");s.src=t[i];s.async=true;s.onerror=function(){l(i+1)};document.head.appendChild(s)}l(0)})();
</script>
</head>
<body>
  <div class="brandbar">
    <div class="brandwrap">
      <div class="brandtitle">TIEVA - Identity & Access Analyzer</div>
      <div class="btnrow">
        <button id="btnExportHTML" class="header-btn">Export HTML</button>
        <button id="btnDownloadDetail" class="header-btn">Download Detail CSV</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="pagetitle">RBAC and privileged access posture overview</div>
    <div class="status">
      Upload your <strong>Identity_Audit.xlsx</strong> to analyze RBAC assignments, privileged access, 
      service principals, guest users, and custom roles.
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <h3>Identity Audit (.xlsx)</h3>
          <input id="auditXlsx" type="file" accept=".xlsx" />
          <div class="muted" style="font-size:12px;margin-top:4px">
            Expected sheets: <code>Privileged_Access</code>, <code>Service_Principals</code>, 
            <code>Guest_Users</code>, <code>Custom_Roles</code>, <code>Findings</code>
          </div>
        </div>
        <div class="col" style="display:flex;align-items:flex-end;gap:8px">
          <div class="btn primary" id="go" role="button" tabindex="0">Generate report</div>
          <div class="btn" id="clearFilter">Clear filter</div>
          <span id="status" class="muted" style="align-self:center"></span>
        </div>
      </div>
    </div>

    <div id="kpiSec" class="row hidden">
      <div class="col card">
        <h2>At a glance</h2>
        <div class="tiles">
          <div class="tile"><h4>Total Assignments</h4><div class="big" id="kpiAssignments">0</div></div>
          <div class="tile"><h4>Privileged Access</h4><div class="big" id="kpiPrivileged">0</div></div>
          <div class="tile"><h4>Service Principals</h4><div class="big" id="kpiSPs">0</div></div>
          <div class="tile"><h4>Guest Users</h4><div class="big" id="kpiGuests">0</div></div>
          <div class="tile"><h4>Custom Roles</h4><div class="big" id="kpiCustom">0</div></div>
          <div class="tile"><h4>High-Risk Findings</h4><div class="big" id="kpiFindings">0</div></div>
        </div>
      </div>
    </div>

    <div id="summarySec" class="row hidden">
      <div class="col card">
        <h2>Summary</h2>
        <div class="row">
          <div class="col">
            <h3>By Risk Level</h3>
            <div id="tblRiskSummary" class="scroller"></div>
          </div>
          <div class="col">
            <h3>High-Risk Privileged Access</h3>
            <div id="tblHighRisk" class="scroller"></div>
          </div>
          <div class="col">
            <h3>Subscription Admins</h3>
            <div id="tblSubAdmins" class="scroller"></div>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <h3>Service Principals</h3>
            <div id="tblSPs" class="scroller"></div>
          </div>
          <div class="col">
            <h3>Guest Users</h3>
            <div id="tblGuests" class="scroller"></div>
          </div>
          <div class="col">
            <h3>Custom Roles</h3>
            <div id="tblCustomRoles" class="scroller"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="findingsSec" class="row hidden">
      <div class="col card">
        <div class="filterbar">
          <h2 style="margin:0">Findings & Recommendations</h2>
          <span class="pill" id="activeFilter" style="display:none"></span>
        </div>
        <div id="tblFindings" class="scroller"></div>
      </div>
    </div>
  </div>

<script>
let DATA = { privileged:[], assignments:[], sps:[], guests:[], customRoles:[], subAdmins:[], findings:[] };
let FILTER = { active:false, key:null, value:null };

const $ = id => document.getElementById(id);
const escapeHtml = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

function status(t){ $('status').textContent = t||''; }

function readSheet(wb, name) {
  if (!wb.SheetNames.includes(name)) return [];
  return XLSX.utils.sheet_to_json(wb.Sheets[name], {defval:''});
}

function applyFilter(key, value) {
  FILTER = { active:true, key, value };
  $('activeFilter').style.display = '';
  $('activeFilter').textContent = 'Filter: ' + key + ' = ' + value;
  renderAll();
}

function clearFilter() {
  FILTER = { active:false, key:null, value:null };
  $('activeFilter').style.display = 'none';
  renderAll();
}

function filterData(data) {
  if (!FILTER.active) return data;
  return data.filter(item => String(item[FILTER.key]||'').toLowerCase() === String(FILTER.value).toLowerCase());
}

function renderTable(el, columns, rows, clickKey) {
  let html = '<table><thead><tr>';
  columns.forEach(c => html += `<th>${c.header}</th>`);
  html += '</tr></thead><tbody>';
  rows.forEach(r => {
    const attr = clickKey && r[clickKey] != null ? ` data-filter="${clickKey}" data-value="${escapeHtml(r[clickKey])}"` : '';
    html += `<tr${attr}>`;
    columns.forEach(c => html += `<td>${c.render ? c.render(r) : escapeHtml(r[c.key]||'')}</td>`);
    html += '</tr>';
  });
  html += '</tbody></table>';
  el.innerHTML = html;
  if (clickKey) {
    el.querySelectorAll('tbody tr[data-filter]').forEach(tr => {
      tr.addEventListener('click', () => applyFilter(tr.getAttribute('data-filter'), tr.getAttribute('data-value')));
    });
  }
}

function riskPill(risk) {
  const r = String(risk||'').toLowerCase();
  if (r === 'high') return '<span class="tag high">HIGH</span>';
  if (r === 'medium') return '<span class="tag medium">MEDIUM</span>';
  if (r === 'low') return '<span class="tag low">LOW</span>';
  return `<span class="tag">${escapeHtml(risk)}</span>`;
}

function typeBadge(type) {
  return `<span class="badge-type">${escapeHtml(type)}</span>`;
}

function yesNoPill(val) {
  const v = String(val||'').toLowerCase();
  if (v === 'true' || v === 'yes') return '<span class="tag high">Yes</span>';
  if (v === 'false' || v === 'no') return '<span class="tag low">No</span>';
  return escapeHtml(val);
}

function groupBy(arr, key) {
  const m = {};
  arr.forEach(x => { const k = x[key]||'(blank)'; (m[k]||(m[k]=[])).push(x); });
  return m;
}

function renderAll() {
  const privileged = filterData(DATA.privileged);
  const sps = filterData(DATA.sps);
  const guests = filterData(DATA.guests);
  const customRoles = filterData(DATA.customRoles);
  const subAdmins = filterData(DATA.subAdmins);
  const findings = filterData(DATA.findings);

  $('kpiAssignments').textContent = DATA.assignments.length;
  $('kpiPrivileged').textContent = privileged.length;
  $('kpiSPs').textContent = sps.length;
  $('kpiGuests').textContent = guests.length;
  $('kpiCustom').textContent = customRoles.length;
  $('kpiFindings').textContent = findings.filter(f => f.Severity === 'High').length;

  const byRisk = groupBy(privileged, 'RiskLevel');
  const riskRows = Object.entries(byRisk).map(([risk, arr]) => ({ RiskLevel: risk, count: arr.length }))
    .sort((a,b) => { const order = {High:0,Medium:1,Low:2}; return (order[a.RiskLevel]??3) - (order[b.RiskLevel]??3); });
  
  renderTable($('tblRiskSummary'), [
    { key:'RiskLevel', header:'Risk Level', render: r => riskPill(r.RiskLevel) },
    { key:'count', header:'Count' }
  ], riskRows, 'RiskLevel');

  const highRisk = privileged.filter(p => p.RiskLevel === 'High');
  renderTable($('tblHighRisk'), [
    { key:'SubscriptionName', header:'Subscription' },
    { key:'DisplayName', header:'Principal' },
    { key:'ObjectType', header:'Type', render: r => typeBadge(r.ObjectType) },
    { key:'Role', header:'Role' },
    { key:'RiskLevel', header:'Risk', render: r => riskPill(r.RiskLevel) }
  ], highRisk.slice(0, 50), 'SubscriptionName');

  renderTable($('tblSubAdmins'), [
    { key:'SubscriptionName', header:'Subscription' },
    { key:'DisplayName', header:'Principal' },
    { key:'SignInName', header:'Sign-In' },
    { key:'ObjectType', header:'Type', render: r => typeBadge(r.ObjectType) },
    { key:'Role', header:'Role' }
  ], subAdmins, 'SubscriptionName');

  renderTable($('tblSPs'), [
    { key:'SubscriptionName', header:'Subscription' },
    { key:'DisplayName', header:'Display Name' },
    { key:'RoleCount', header:'Roles' },
    { key:'Roles', header:'Role Names' },
    { key:'HasPrivilegedRole', header:'Privileged', render: r => yesNoPill(r.HasPrivilegedRole) }
  ], sps, 'SubscriptionName');

  renderTable($('tblGuests'), [
    { key:'SubscriptionName', header:'Subscription' },
    { key:'DisplayName', header:'Display Name' },
    { key:'SignInName', header:'Sign-In' },
    { key:'RoleCount', header:'Roles' },
    { key:'HasPrivilegedRole', header:'Privileged', render: r => yesNoPill(r.HasPrivilegedRole) }
  ], guests, 'SubscriptionName');

  renderTable($('tblCustomRoles'), [
    { key:'SubscriptionName', header:'Subscription' },
    { key:'RoleName', header:'Role Name' },
    { key:'Description', header:'Description' },
    { key:'ActionCount', header:'Actions' },
    { key:'HasWildcard', header:'Wildcard', render: r => yesNoPill(r.HasWildcard) }
  ], customRoles, 'SubscriptionName');

  renderTable($('tblFindings'), [
    { key:'SubscriptionName', header:'Subscription' },
    { key:'Severity', header:'Severity', render: r => riskPill(r.Severity) },
    { key:'Category', header:'Category' },
    { key:'ResourceName', header:'Resource' },
    { key:'Detail', header:'Finding' },
    { key:'Recommendation', header:'Recommendation' }
  ], findings, 'SubscriptionName');

  const show = DATA.privileged.length > 0 || DATA.findings.length > 0;
  ['kpiSec','summarySec','findingsSec'].forEach(id => {
    $(id).classList.toggle('hidden', !show);
  });
}

function cleanCell(v) {
  if (!v) return '';
  let s = String(v).trim();
  s = s.replace(/^[=+\-@]+/, '');
  s = s.replace(/^-\s*/, '');
  return s;
}

async function handleGenerate() {
  try {
    status('');
    const file = $('auditXlsx').files[0];
    if (!file) { status('Choose the Identity audit workbook.'); return; }
    
    if (typeof XLSX === 'undefined') { status('XLSX library loading...'); return; }
    
    const btn = $('go');
    btn.textContent = 'Generating...';
    btn.style.opacity = '.7';
    
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type: 'array' });
    
    DATA.privileged = readSheet(wb, 'Privileged_Access');
    DATA.assignments = readSheet(wb, 'All_Role_Assignments');
    DATA.sps = readSheet(wb, 'Service_Principals');
    DATA.guests = readSheet(wb, 'Guest_Users');
    DATA.customRoles = readSheet(wb, 'Custom_Roles');
    DATA.subAdmins = readSheet(wb, 'Subscription_Admins');
    DATA.findings = readSheet(wb, 'Findings');
    
    FILTER = { active:false, key:null, value:null };
    $('activeFilter').style.display = 'none';
    renderAll();
    
    status(`Report generated - ${DATA.findings.length} findings.`);
  } catch (err) {
    console.error(err);
    status('Error: ' + (err?.message || err));
  } finally {
    $('go').textContent = 'Generate report';
    $('go').style.opacity = '';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  $('go').addEventListener('click', handleGenerate);
  $('clearFilter').addEventListener('click', clearFilter);
  
  $('btnDownloadDetail').addEventListener('click', () => {
    const data = FILTER.active ? filterData(DATA.findings) : DATA.findings;
    if (!data.length) { alert('Generate report first.'); return; }
    
    const today = new Date().toISOString().slice(0, 10);
    
    const rows = data.map(d => ({
      "Date Identified": today,
      "Ticket Number": "",
      "Issue Description": cleanCell(d.Detail),
      "Impact": cleanCell(d.Severity),
      "Affected Resource(s)": cleanCell([d.SubscriptionName, d.ResourceGroup, d.ResourceName].filter(Boolean).join(" / ")),
      "Azure Service / Category": cleanCell(d.Category || d.ResourceType),
      "Root Cause": cleanCell(d.Detail),
      "Recommendation": cleanCell(d.Recommendation),
      "Justification / Benefit": cleanCell(d.Recommendation),
      "Priority": cleanCell(d.Severity),
      "Status": "Open",
      "Owner / Engineer": "",
      "Target Resolution Date": "",
      "Date Resolved": "",
      "Customer Feedback / Notes": "",
      "Follow-up Actions": "",
      "Validation Date": "",
      "Comments": ""
    }));
    
    const headers = [
      "Date Identified", "Ticket Number", "Issue Description", "Impact",
      "Affected Resource(s)", "Azure Service / Category", "Root Cause",
      "Recommendation", "Justification / Benefit", "Priority", "Status",
      "Owner / Engineer", "Target Resolution Date", "Date Resolved",
      "Customer Feedback / Notes", "Follow-up Actions", "Validation Date", "Comments"
    ];
    
    let csv = headers.join(",") + "\n";
    rows.forEach(r => {
      const vals = headers.map(h => {
        const v = cleanCell(r[h] || "");
        return /[",\n]/.test(v) ? '"' + v.replace(/"/g, '""') + '"' : v;
      });
      csv += vals.join(",") + "\n";
    });
    
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "identity_access_findings.csv";
    a.click();
  });
  
  $('btnExportHTML').addEventListener('click', () => {
    const html = '<!doctype html>' + document.documentElement.outerHTML;
    const blob = new Blob([html], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'TIEVA - Identity & Access Analyzer.html';
    a.click();
  });
});
</script>
</body>
</html>
